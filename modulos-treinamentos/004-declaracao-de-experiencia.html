<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homologação de Competência | Sistema Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --border: #e2e8f0;
            --bg: #f9fafb;
            --text: #0f172a;
            --muted: #64748b;
            --card-bg: #ffffff;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background-color: var(--bg); color: var(--text); overflow: hidden; }
        
        .container { display: flex; height: 100vh; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 320px; padding: 32px 24px; background: var(--card-bg);
            border-right: 1px solid var(--border); display: flex;
            flex-direction: column; gap: 28px; flex-shrink: 0;
        }

        .content { flex: 1; padding: 40px; display: flex; flex-direction: column; overflow-y: auto; }
        
        h2 { font-size: 18px; font-weight: 700; margin-bottom: 24px; }
        .section-title { text-transform: uppercase; font-size: 11px; font-weight: 700; color: var(--muted); margin-bottom: 12px; letter-spacing: 0.05em; }

        label { font-size: 13px; font-weight: 600; display: block; margin-bottom: 6px; color: #475569; }

        select, input, textarea {
            width: 100%; padding: 10px 12px; font-size: 14px;
            border: 1px solid var(--border); border-radius: 6px; background: white;
            transition: all 0.2s;
        }
        select:focus, input:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        textarea { resize: vertical; min-height: 120px; }

        /* --- BOTÕES DE EVIDÊNCIA --- */
        .evidence-button {
            padding: 14px 16px; border: 1px solid var(--border);
            border-radius: 8px; background: var(--card-bg); cursor: pointer;
            font-weight: 600; font-size: 14px; margin-bottom: 12px;
            transition: 0.2s; display: flex; flex-direction: column;
        }
        .evidence-button.active { border-color: var(--primary); background: #eff6ff; color: var(--primary); }
        .evidence-button small { font-weight: 400; color: var(--muted); margin-top: 4px; font-size: 12px; }

        .warning-box {
            background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af;
            padding: 12px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; margin-bottom: 20px;
        }

        .row { display: flex; gap: 16px; margin-bottom: 20px; }
        .row > div { flex: 1; }
        
        .checkbox { display: flex; align-items: center; gap: 10px; font-size: 13px; margin-top: 16px; font-weight: 500; }

        .footer { margin-top: auto; display: flex; justify-content: flex-end; gap: 12px; padding-top: 40px; }
        .btn { padding: 12px 24px; font-weight: 600; border-radius: 8px; border: none; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--muted); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }

        .viewer-badge { display: none; background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; font-size: 11px; padding: 4px 12px; border-radius: 100px; font-weight: 700; }
    </style>
</head>
<body>
<div class="container">
    
    <aside class="sidebar">
        <div>
            <div class="section-title">1. Configuração do Registro</div>
            <label>Colaborador</label>
            <select id="selectColaborador"><option value="">Carregando...</option></select>
            
            <label style="margin-top: 20px;">Curso / Competência Alvo</label>
            <select id="selectTreinamento"><option value="">Carregando catálogo...</option></select>
            <small style="color: var(--muted); font-size: 11px; margin-top: 4px; display: block;">Vínculo oficial com a matriz de treinamentos.</small>
        </div>

        <div>
            <div class="section-title">2. Tipo de Evidência</div>
            <div id="btn-cert" class="evidence-button active" onclick="selectMode('certificado', this)">
                <span>Certificado Externo</span>
                <small>Documento emitido por terceiros.</small>
            </div>
            <div id="btn-notorio" class="evidence-button" onclick="selectMode('notorio', this)">
                <span>Parecer Notório Saber</span>
                <small>Validação técnica do RH/Gestão.</small>
            </div>
        </div>
    </aside>

    <main class="content">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <h2 id="main-title">3. Detalhes da Homologação (Certificado)</h2>
            <div id="viewerWarning" class="viewer-badge">MODO LEITURA</div>
        </div>

        <div id="form-certificado">
            <div class="row">
                <div style="flex: 2;">
                    <label>Instituição Emissora</label>
                    <input type="text" id="certInstituicao" placeholder="Ex: SENAI, FGV, Alura...">
                </div>
                <div style="flex: 1;">
                    <label>Data de Conclusão</label>
                    <input type="date" id="certData">
                </div>
            </div>
            <div class="row">
                <div style="flex: 1;">
                    <label>Validade (Meses)</label>
                    <select id="certValidade">
                        <option value="12" selected>12 meses</option>
                        <option value="24">24 meses</option>
                        <option value="0">Indeterminada</option>
                    </select>
                </div>
                <div style="flex: 2;">
                    <label>Link de Validação / Credencial</label>
                    <input type="url" id="certLink" placeholder="https://...">
                </div>
            </div>
        </div>

        <div id="form-notorio" style="display: none">
            <div class="warning-box">
                Parecer Técnico: Este registro certifica a proficiência do colaborador através de avaliação interna, dispensando o certificado formal.
            </div>
            <div class="row">
                <div style="flex: 1">
                    <label>Justificativa da Validação</label>
                    <textarea id="notorioJustificativa" placeholder="Descreva os projetos, experiências ou testes práticos que comprovam o domínio desta competência..."></textarea>
                </div>
            </div>
            <div class="row">
                <div>
                    <label>Aprovador Técnico (Gestor/Especialista)</label>
                    <input type="text" id="notorioAprovador" placeholder="Nome do responsável pelo aval técnico">
                </div>
                <div>
                    <label>Data da Validação</label>
                    <input type="date" id="notorioData">
                </div>
            </div>
            <div class="checkbox">
                <input type="checkbox" id="checkRH">
                <label for="checkRH" style="margin-bottom:0; cursor:pointer;">Confirmo que as competências foram validadas conforme critérios internos do RH.</label>
            </div>
        </div>

        <div class="footer">
            <button class="btn btn-outline" onclick="window.location.reload()">Cancelar</button>
            <button class="btn btn-primary" id="btnSalvar" onclick="salvarCertificacao()">Gravar Homologação</button>
        </div>
    </main>
</div>

<script type="module">
    import { DBHandler } from '../bd-treinamentos/db-handler.js';

    let currentMode = 'certificado';

    document.addEventListener('DOMContentLoaded', async () => {
        await carregarDadosIniciais();
        setarDatasPadrao();
    });

    function setarDatasPadrao() {
        const hoje = new Date().toISOString().split('T')[0];
        document.getElementById('certData').value = hoje;
        document.getElementById('notorioData').value = hoje;
    }

    async function carregarDadosIniciais() {
        try {
            const colabs = await DBHandler.listarColaboradores({ somenteAtivos: true });
            document.getElementById('selectColaborador').innerHTML = '<option value="">Selecione o colaborador...</option>' + 
                colabs.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

            const { treinamentos } = await DBHandler.carregarDadosIniciais();
            document.getElementById('selectTreinamento').innerHTML = '<option value="">Selecione o curso...</option>' + 
                treinamentos.map(t => `<option value="${t.id}">${t.nome}</option>`).join('');
        } catch (e) { console.error("Erro no boot:", e); }
    }

    window.selectMode = function(mode, el) {
        currentMode = mode;
        document.querySelectorAll('.evidence-button').forEach(btn => btn.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('form-certificado').style.display = (mode === 'certificado') ? 'block' : 'none';
        document.getElementById('form-notorio').style.display = (mode === 'notorio') ? 'block' : 'none';
        document.getElementById('main-title').textContent = mode === 'certificado' ? '3. Detalhes da Homologação (Certificado)' : '3. Parecer de Notório Saber (Validação RH)';
    }

    window.salvarCertificacao = async function() {
        const session = JSON.parse(localStorage.getItem('rh_session'));
        const btn = document.getElementById('btnSalvar');

        const colabSel = document.getElementById('selectColaborador');
        const treinoSel = document.getElementById('selectTreinamento');

        const payload = {
            colaborador_id: colabSel.value,
            treinamento_id: treinoSel.value, // Obrigatório vir do combo
            data_homologacao: currentMode === 'certificado' ? document.getElementById('certData').value : document.getElementById('notorioData').value,
            validade_meses: currentMode === 'certificado' ? document.getElementById('certValidade').value : 12,
            instrutor: currentMode === 'certificado' ? document.getElementById('certInstituicao').value : document.getElementById('notorioAprovador').value,
            usuario_registro: session.user,
            status: 'Homologado (Auditado)',
            observacoes: currentMode === 'notorio' ? document.getElementById('notorioJustificativa').value : null,
            atividade_externa: currentMode === 'certificado' ? 'CERTIFICADO_EXTERNO' : 'NOTORIO_SABER'
        };

        if (!payload.colaborador_id || !payload.treinamento_id) {
            alert("Selecione o colaborador e o curso alvo."); return;
        }

        if (currentMode === 'notorio' && !document.getElementById('checkRH').checked) {
            alert("O analista do RH deve confirmar a validação dos critérios."); return;
        }

        try {
            btn.disabled = true;
            btn.textContent = "Gravando...";

            // 1. Salvar na tabela de homologações
            await DBHandler.salvarHomologacao(payload);

            // 2. Registro de Log para a Administração
            const colabNome = colabSel.options[colabSel.selectedIndex].text;
            const treinoNome = treinoSel.options[treinoSel.selectedIndex].text;
            
            const detalhesAudit = `• AÇÃO: VALIDAÇÃO RH (${currentMode.toUpperCase()})\n` +
                                `• Colaborador: ${colabNome}\n` +
                                `• Competência: ${treinoNome}\n` +
                                `• Evidência/Aprovador: ${payload.instrutor}`;

            await DBHandler.registrarLog(session.user, "HOMOLOGAR_COMPETENCIA", detalhesAudit, "Homologação de Competência");

            alert("Sucesso! Registro de competência e rastro de auditoria concluídos.");
            window.location.reload();
        } catch (e) {
            alert("Erro: " + e.message);
            btn.disabled = false;
            btn.textContent = "Gravar Homologação";
        }
    }
</script>
</body>
</html>
