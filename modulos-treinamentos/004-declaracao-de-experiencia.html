<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gest√£o de Certifica√ß√µes | Academy</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --border: #e2e8f0;
      --bg: #f8fafc;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --white: #ffffff;
      --view-blue: #2563eb;
      --edit-purple: #7c3aed;
      --delete-red: #dc2626;
    }

    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background-color: var(--bg); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

    /* HEADER */
    .app-header {
      height: 56px; background: var(--white); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 24px; justify-content: space-between; flex-shrink: 0;
    }
    .header-title { font-size: 16px; font-weight: 800; color: var(--primary); letter-spacing: -0.02em; }

    /* FILTROS (AJUSTADOS) */
    .filter-bar { background: var(--white); padding: 12px 24px; border-bottom: 1px solid var(--border); }
    .filter-inner { display: flex; gap: 16px; align-items: flex-end; width: 100%; }
    .filter-group { display: flex; flex-direction: column; gap: 4px; }
    .filter-group label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
    
    #searchBox { flex: 1; min-width: 300px; }
    #filterTipo { width: 160px; }

    .search-input, .filter-select, .form-control {
      height: 34px; padding: 0 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: #f1f5f9;
    }

    /* TABELA (ALTA DENSIDADE) */
    .table-container { flex: 1; overflow: auto; padding: 16px 24px; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; background: var(--white); border-radius: 8px; border: 1px solid var(--border); }
    th { background: #f8fafc; text-align: left; padding: 8px 12px; font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border); }
    td { padding: 6px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; line-height: 1.2; }
    tr:hover td { background: #fcfdfe; }

    /* BOT√ïES */
    .btn { height: 34px; padding: 0 16px; border-radius: 6px; font-weight: 700; cursor: pointer; border: 1px solid var(--border); font-size: 12px; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; border: none; }
    .btn-outline { background: white; color: var(--text-muted); }
    .btn-action { width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; }
    .btn-view { background: #eff6ff; color: var(--view-blue); border: 1px solid #dbeafe; }
    .btn-edit { background: #f5f3ff; color: var(--edit-purple); border: 1px solid #ede9fe; }
    .btn-delete { background: #fef2f2; color: var(--delete-red); border: 1px solid #fee2e2; }

    /* VIEWS */
    #view-lista, #view-formulario { flex: 1; display: none; flex-direction: column; overflow: hidden; animation: fadeIn 0.2s ease; }
    #view-lista.active, #view-formulario.active { display: flex; }

    /* FORMUL√ÅRIO LAYOUT */
    .form-content { display: flex; height: 100%; }
    .sidebar { width: 300px; padding: 24px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 16px; }
    .main-form { flex: 1; padding: 32px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
    .form-card { width: 100%; max-width: 700px; background: white; padding: 24px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    
    .evidence-button { padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; background: #fcfdfe; transition: 0.2s; }
    .evidence-button.active { border-color: var(--primary); background: #eff6ff; color: var(--primary); font-weight: 700; }
    .readonly-mode input, .readonly-mode select, .readonly-mode textarea { background-color: #f1f5f9; border-style: dashed; pointer-events: none; color: #475569; }
    .admin-only { display: none; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="header-title">ACADEMY // CERTIFICA√á√ïES</div>
    <button class="btn btn-primary admin-only" id="btnTopNovo" onclick="window.abrirFormulario()">
      ‚ûï NOVO REGISTRO
    </button>
  </header>

  <div id="view-lista" class="active">
    <div class="filter-bar">
      <div class="filter-inner">
        <div class="filter-group" style="flex: 1;">
          <label>Pesquisar Colaborador ou Curso</label>
          <input type="text" id="searchBox" class="search-input" onkeyup="window.filtrar()" placeholder="Digite para buscar...">
        </div>
        <div class="filter-group">
          <label>Tipo</label>
          <select id="filterTipo" class="filter-select" onchange="window.filtrar()">
            <option value="TODOS">Todos</option>
            <option value="CERTIFICADO">Certificados</option>
            <option value="NOTORIO">Not√≥rio Saber</option>
          </select>
        </div>
        <button class="btn btn-outline" onclick="window.limparFiltros()">LIMPAR</button>
      </div>
    </div>

    <div class="table-container">
      <table id="homologTable">
        <thead>
          <tr>
            <th>Colaborador</th>
            <th>Compet√™ncia</th>
            <th>Tipo</th>
            <th>Data</th>
            <th>Nota</th>
            <th style="text-align:right">A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="view-formulario">
    <div class="form-content" id="formWrapper">
      <aside class="sidebar">
        <label>1. Colaborador</label>
        <select id="selectColaborador" class="form-control"><option value="">Carregando...</option></select>
        
        <label>2. Compet√™ncia</label>
        <select id="selectTreinamento" class="form-control"><option value="">Carregando...</option></select>

        <label>3. Tipo de Evid√™ncia</label>
        <div id="btn-cert" class="evidence-button active" onclick="window.selectMode('certificado', this)">
          <b>Certificado</b><br><small>Curso Externo/Interno</small>
        </div>
        <div id="btn-notorio" class="evidence-button" onclick="window.selectMode('notorio', this)">
          <b>Not√≥rio Saber</b><br><small>Avalia√ß√£o T√©cnica</small>
        </div>
      </aside>

      <main class="main-form">
        <div class="form-card">
          <h2 id="form-title" style="margin: 0 0 20px 0; font-size: 18px;">Novo Registro</h2>
          
          <div id="form-certificado">
            <div style="display: flex; gap: 16px;">
              <div style="flex: 2;">
                <label style="font-size: 10px; font-weight: 700; color: var(--text-muted);">INSTITUI√á√ÉO</label>
                <input type="text" id="certInstituicao" class="form-control" value="Edesoft-Academy" readonly>
                <label style="display: flex; align-items: center; gap: 5px; text-transform: none; font-weight: 500;">
                  <input type="checkbox" id="checkEdesoft" checked onchange="window.toggleInstituicao(this.checked)"> Padr√£o Academy
                </label>
              </div>
              <div style="flex: 1;">
                <label style="font-size: 10px; font-weight: 700; color: var(--text-muted);">DATA</label>
                <input type="date" id="certData" class="form-control">
              </div>
            </div>
            <div style="display: flex; gap: 16px; margin-top: 20px;">
              <div style="flex: 1;">
                <label style="font-size: 10px; font-weight: 700; color: var(--text-muted);">NOTA</label>
                <input type="number" id="certNota" class="form-control" placeholder="N/A" readonly step="0.1">
                <label style="display: flex; align-items: center; gap: 5px; text-transform: none; font-weight: 500;">
                  <input type="checkbox" id="checkNotaNA" checked onchange="window.toggleNota(this.checked)"> N√£o se aplica
                </label>
              </div>
              <div style="flex: 2;">
                <label style="font-size: 10px; font-weight: 700; color: var(--text-muted);">LINK DE VALIDA√á√ÉO</label>
                <input type="url" id="certLink" class="form-control" placeholder="https://...">
              </div>
            </div>
          </div>

          <div id="form-notorio" style="display: none;">
            <label style="font-size: 10px; font-weight: 700; color: var(--text-muted);">JUSTIFICATIVA T√âCNICA</label>
            <textarea id="notorioJustificativa" class="form-control" style="height: 100px; padding: 10px;" placeholder="Evid√™ncias de profici√™ncia..."></textarea>
            <label style="font-size: 10px; font-weight: 700; color: var(--text-muted);">APROVADOR T√âCNICO</label>
            <input type="text" id="notorioAprovador" class="form-control" placeholder="Nome do gestor">
          </div>

          <div class="footer">
            <button class="btn btn-outline" onclick="window.voltarParaLista()">CANCELAR</button>
            <button class="btn btn-primary" id="btnSalvar" onclick="window.salvarHomologacao()">GRAVAR</button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script type="module">
    import { DBHandler } from '../bd-treinamentos/db-handler.js';
    let DADOS_LISTA = [];
    let currentId = null;
    let currentMode = 'CERTIFICADO';

    // --- INICIALIZA√á√ÉO ---
    window.addEventListener('DOMContentLoaded', async () => {
      const session = JSON.parse(localStorage.getItem('rh_session')) || { role: 'VIEWER' };
      if (session.role === 'ADMIN') {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
      }
      await carregarCombos();
      await window.carregarLista();
    });

    async function carregarCombos() {
      try {
        const colabs = await DBHandler.listarColaboradores({ somenteAtivos: true });
        document.getElementById('selectColaborador').innerHTML = '<option value="">Selecione...</option>' + 
          colabs.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');

        const { treinamentos } = await DBHandler.carregarDadosIniciais();
        document.getElementById('selectTreinamento').innerHTML = '<option value="">Selecione...</option>' + 
          treinamentos.map(t => `<option value="${t.id}">${t.nome}</option>`).join('');
      } catch (e) { console.error(e); }
    }

    // --- LISTA ---
    window.carregarLista = async () => {
      DADOS_LISTA = await DBHandler.listarHomologacoes();
      renderizarTabela(DADOS_LISTA);
    };

    function renderizarTabela(lista) {
      const tbody = document.querySelector("#homologTable tbody");
      const session = JSON.parse(localStorage.getItem('rh_session')) || { role: 'VIEWER' };

      tbody.innerHTML = lista.map(item => `
        <tr>
          <td><strong>${item.colaboradores?.nome || '‚Äî'}</strong></td>
          <td>${item.treinamentos?.nome || '‚Äî'}</td>
          <td><span class="badge ${item.atividade_externa === 'NOTORIO' ? 'type-notorio' : 'type-cert'}">${item.atividade_externa || 'CERTIFICADO'}</span></td>
          <td>${item.data_homologacao ? new Date(item.data_homologacao).toLocaleDateString('pt-BR') : '‚Äî'}</td>
          <td>${item.nota || 'N/A'}</td>
          <td class="actions-cell">
            <button class="btn-action btn-view" onclick="window.abrirFormulario(${item.id}, true)">üëÅÔ∏è</button>
            ${session.role === 'ADMIN' ? `
              <button class="btn-action btn-edit" onclick="window.abrirFormulario(${item.id}, false)">‚úèÔ∏è</button>
              <button class="btn-action btn-delete" onclick="window.deletarRegistro(${item.id})">üóëÔ∏è</button>
            ` : ''}
          </td>
        </tr>
      `).join('');
    }

    window.filtrar = () => {
      const busca = document.getElementById('searchBox').value.toLowerCase();
      const tipo = document.getElementById('filterTipo').value;
      renderizarTabela(DADOS_LISTA.filter(i =>
        ((i.colaboradores?.nome || "").toLowerCase().includes(busca) ||
         (i.treinamentos?.nome || "").toLowerCase().includes(busca)) &&
        (tipo === 'TODOS' || i.atividade_externa === tipo)
      ));
    };

    window.limparFiltros = () => {
      document.getElementById('searchBox').value = "";
      document.getElementById('filterTipo').value = "TODOS";
      renderizarTabela(DADOS_LISTA);
    };

    // --- FORMUL√ÅRIO ---
    window.abrirFormulario = async (id = null, visualizar = false) => {
      currentId = id;
      document.getElementById('view-lista').classList.remove('active');
      document.getElementById('view-formulario').classList.add('active');
      document.getElementById('btnTopNovo').style.display = 'none';

      if (id) {
        const dado = await DBHandler.buscarHomologacaoPorId(id);
        preencherCampos(dado);
        travarCampos(visualizar);
        document.getElementById('form-title').textContent = visualizar ? 'Visualizar Registro' : 'Editar Registro';
      } else {
        resetarFormulario();
        travarCampos(false);
        document.getElementById('form-title').textContent = 'Novo Registro';
      }
    };

    window.voltarParaLista = () => {
      document.getElementById('view-formulario').classList.remove('active');
      document.getElementById('view-lista').classList.add('active');
      const session = JSON.parse(localStorage.getItem('rh_session'));
      if(session?.role === 'ADMIN') document.getElementById('btnTopNovo').style.display = 'inline-flex';
    };

    window.selectMode = (mode, el) => {
      currentMode = mode.toUpperCase();
      document.querySelectorAll('.evidence-button').forEach(b => b.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('form-certificado').style.display = mode === 'certificado' ? 'block' : 'none';
      document.getElementById('form-notorio').style.display = mode === 'notorio' ? 'block' : 'none';
    };

    window.toggleInstituicao = (check) => {
      const input = document.getElementById('certInstituicao');
      input.value = check ? "Edesoft-Academy" : "";
      input.readOnly = check;
    };

    window.toggleNota = (check) => {
      const input = document.getElementById('certNota');
      input.readOnly = check;
      input.placeholder = check ? "N/A" : "0.0";
      if (check) input.value = "";
    };

    window.salvarHomologacao = async () => {
      const session = JSON.parse(localStorage.getItem('rh_session'));
      const payload = {
        colaborador_id: document.getElementById('selectColaborador').value,
        treinamento_id: document.getElementById('selectTreinamento').value,
        usuario_registro: session.user,
        atividade_externa: currentMode,
        data_homologacao: currentMode === 'CERTIFICADO' ? document.getElementById('certData').value : new Date().toISOString().split('T')[0],
        nota: (currentMode === 'CERTIFICADO' && !document.getElementById('checkNotaNA').checked) ? document.getElementById('certNota').value : null,
        instrutor: currentMode === 'CERTIFICADO' ? document.getElementById('certInstituicao').value : document.getElementById('notorioAprovador').value,
        observacoes: currentMode === 'NOTORIO' ? document.getElementById('notorioJustificativa').value : (document.getElementById('certLink').value || null)
      };

      try {
        await DBHandler.salvarHomologacao({ ...(currentId ? { id: currentId } : {}), ...payload });
        alert("‚úÖ Salvo com sucesso!");
        window.voltarParaLista();
        await window.carregarLista();
      } catch (e) { alert(e.message); }
    };

    window.deletarRegistro = async (id) => {
      if (!confirm('Deseja realmente excluir?')) return;
      try {
        await DBHandler.excluirHomologacao(id);
        await window.carregarLista();
      } catch (e) { alert(e.message); }
    };

    function preencherCampos(d) {
      document.getElementById('selectColaborador').value = d.colaborador_id;
      document.getElementById('selectTreinamento').value = d.treinamento_id;
      if (d.atividade_externa === 'NOTORIO') {
        window.selectMode('notorio', document.getElementById('btn-notorio'));
        document.getElementById('notorioJustificativa').value = d.observacoes || "";
        document.getElementById('notorioAprovador').value = d.instrutor || "";
      } else {
        window.selectMode('certificado', document.getElementById('btn-cert'));
        document.getElementById('certInstituicao').value = d.instrutor || "Edesoft-Academy";
        document.getElementById('checkEdesoft').checked = (d.instrutor === "Edesoft-Academy");
        document.getElementById('certData').value = d.data_homologacao;
        document.getElementById('certLink').value = d.observacoes || "";
        if(d.nota) {
          document.getElementById('checkNotaNA').checked = false;
          window.toggleNota(false);
          document.getElementById('certNota').value = d.nota;
        } else {
          document.getElementById('checkNotaNA').checked = true;
          window.toggleNota(true);
        }
      }
    }

    function travarCampos(travar) {
      document.querySelectorAll('#view-formulario input, #view-formulario select, #view-formulario textarea').forEach(el => el.disabled = travar);
      document.getElementById('btnSalvar').style.display = travar ? 'none' : 'inline-flex';
      document.getElementById('formWrapper').className = travar ? 'form-content readonly-mode' : 'form-content';
    }

    function resetarFormulario() {
      document.querySelectorAll('#view-formulario input, #view-formulario select, #view-formulario textarea').forEach(el => { el.value = ""; el.disabled = false; });
      document.getElementById('certInstituicao').value = "Edesoft-Academy";
      document.getElementById('checkEdesoft').checked = true;
      document.getElementById('checkNotaNA').checked = true;
      document.getElementById('certData').value = new Date().toISOString().split('T')[0];
      window.selectMode('certificado', document.getElementById('btn-cert'));
    }
  </script>
</body>
</html>
