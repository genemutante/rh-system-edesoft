<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academy | Gest√£o de Certifica√ß√µes</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    
<style>
:root {
--orange-light: #fef3c7;
--orange-dark: #b45309;
  --border: #cbd5e1; /* cinza vis√≠vel */
  --text-main: #0f172a;
  --text-muted: #64748b;
  --bg: #f8fafc;
  --white: #ffffff;
  --primary: #4f46e5;
  --primary-hover: #4338ca;
  --view-blue: #2563eb;
  --edit-purple: #7c3aed;
  --delete-red: #dc2626;
}



.evidence-card {
display: flex;
align-items: center;
gap: 12px;
background: white;
padding: 14px 18px;
border-radius: 12px;
border: 1.5px solid var(--border);
cursor: pointer;
transition: 0.2s;
text-align: left;
box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
}


.evidence-card:hover {
background: #f9fafb;
border-color: var(--primary);
}


.evidence-card.active {
background: #eef4ff;
border-color: var(--primary);
box-shadow: 0 2px 4px rgba(79, 70, 229, 0.15);
}


.icon-box {
font-size: 20px;
width: 36px;
height: 36px;
border-radius: 8px;
display: flex;
align-items: center;
justify-content: center;
flex-shrink: 0;
}


.icon-box.blue {
background: var(--blue-light);
color: var(--blue-dark);
}


.icon-box.orange {
background: var(--orange-light);
color: var(--orange-dark);
}


.text-box {
display: flex;
flex-direction: column;
}


.text-box strong {
font-size: 14px;
font-weight: 700;
color: var(--text-main);
}


.text-box span {
font-size: 12px;
color: var(--text-muted);
}

* { box-sizing: border-box; font-family: 'Inter', sans-serif; }

body {
    margin: 0;
    background-color: var(--bg);
    color: var(--text-main);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* HEADER */
.app-header {
    height: 56px;
    background: var(--white);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 24px;
    justify-content: space-between;
    flex-shrink: 0;
}

.header-brand {
    font-size: 14px;
    font-weight: 800;
    color: var(--primary);
    letter-spacing: 0.05em;
}

/* --- DASHBOARD VIEW --- */
#view-lista {
    flex: 1;
    display: none;
    flex-direction: column;
    overflow: hidden;
}
#view-lista.active { display: flex; }

/* ================= FILTROS ================= */

.filter-bar {
    background: var(--white);
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: flex-end;
}

/* wrapper interno (se existir no HTML) */
.filter-inner {
    max-width: 720px;
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: flex-end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 160px;
    flex: 1 1 220px;
}

.filter-group.grow { flex: 1; }

.filter-group label {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: .5px;
}

/* inputs / selects */
.control-slim {
    height: 36px;
    padding: 0 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 13px;
    background: #ffffff;
    width: 100%;
    transition: .2s;
    box-shadow: 0 1px 2px rgba(0,0,0,.04);
}

.control-slim::placeholder {
    color: #94a3b8;
}

.control-slim:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79,70,229,.15);
}

/* bot√£o limpar alinhado */
.btn {
    height: 36px;
    padding: 0 16px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: .2s;
}

.btn-outline {
    background: white;
    border: 1px solid var(--border);
    color: var(--text-muted);
}

.btn-outline:hover {
    background: var(--bg);
    border-color: var(--primary);
    color: var(--primary);
}

.btn-primary {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background-color: #4f46e5; /* Roxo vibrante */
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  padding: 10px 18px;
  border: none;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  cursor: pointer;
  transition: background-color 0.2s ease;
  text-transform: uppercase;
}

.btn-primary i {
  font-size: 14px;
}

.btn-primary:hover {
  background-color: #4338ca;
}


/* ================= TABELA ================= */

.table-area {
    flex: 1;
    overflow: auto;
    padding: 12px 24px;
}

table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: white;
    border-radius: 8px;
    border: 1px solid var(--border);
}

th {
    background: #f8fafc;
    text-align: left;
    padding: 8px 12px;
    font-size: 10px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
}

td {
    padding: 6px 12px;
    border-bottom: 1px solid #f1f5f9;
    font-size: 13px;
    line-height: 1.2;
}

tr:hover td { background: #fcfdfe; }

/* A√á√ïES */
.btn-action {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: 1px solid transparent;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: .2s;
}

.btn-view { background: #eff6ff; color: var(--view-blue); border-color: #dbeafe; }
.btn-edit { background: #f5f3ff; color: var(--edit-purple); border-color: #ede9fe; }
.btn-delete { background: #fef2f2; color: var(--delete-red); border-color: #fee2e2; }

.btn-view:hover,
.btn-edit:hover,
.btn-delete:hover {
    filter: contrast(1.1) brightness(.95);
}

/* FORM VIEW */

#view-formulario { flex: 1; display: none; overflow: hidden; }
#view-formulario.active { display: flex; }

.form-layout { display: flex; width: 100%; height: 100%; }

.form-sidebar {
    width: 280px;
    background: white;
    border-right: 1px solid var(--border);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.form-main {
    flex: 1;
    padding: 32px;
    background: var(--bg);
    overflow-y: auto;
    display: flex;
    justify-content: center;
}

.form-card {
    width: 100%;
    max-width: 650px;
    background: white;
    padding: 32px;
    border-radius: 12px;
    border: 1px solid var(--border);
    box-shadow: 0 4px 6px rgba(0,0,0,.05);
}

.field-label {
    font-size: 10px;
    font-weight: 800;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 6px;
    display: block;
}

.input-full {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  margin-bottom: 16px;
  background: white; /* importante para contraste */
  color: var(--text-main);
  transition: border-color 0.2s, box-shadow 0.2s;
}

    .input-full:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
  outline: none;
}


.mode-card {
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 8px;
    background: #fcfdfe;
}

.mode-card.active {
    border-color: var(--primary);
    background: #eff6ff;
    color: var(--primary);
    font-weight: 700;
}

.footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
}

/* UTIL */
.badge {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 9px;
    font-weight: 800;
    text-transform: uppercase;
}

.type-cert { background: #e0e7ff; color: #4338ca; }
.type-atestado {
  background: #fef3c7;
  color: #92400e;
}


.readonly-mode .input-full {
    background: #f1f5f9;
    border-style: dashed;
    pointer-events: none;
    color: #475569;
}

.admin-only { display: none; }


.btn-icon {
  background: none;
  border: none;
  padding: 6px;
  margin: 2px;
  font-size: 16px;
  color: #475569;
  transition: color 0.2s ease;
  cursor: pointer;
}

.btn-icon:hover {
  color: #0f172a; /* Slate mais escuro ao passar o mouse */
}

.acoes {
  display: flex;
  gap: 4px;
  justify-content: center;
}

.btn.btn-primary {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background-color: #4f46e5;
  color: white;
  font-weight: 600;
  font-size: 14px;
  padding: 10px 20px;
  border: none;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  cursor: pointer;
  text-transform: uppercase;
  transition: background-color 0.2s ease;
}

.btn.btn-primary i {
  font-size: 14px;
}

.btn.btn-primary:hover {
  background-color: #4338ca;
}

    
</style>

</head>
<body>

    <header class="app-header">
        <div class="header-brand">ACADEMY // GEST√ÉO DE COMPET√äNCIAS</div>
        <button class="btn btn-primary admin-only" id="btnNovo" onclick="window.abrirFormulario()">
  <i class="fas fa-plus"></i> Novo Registro
</button>

    </header>

    <div id="view-lista" class="active">


<div class="filter-bar">
  <div class="filter-inner">
    <div class="filter-group" style="flex: 1;">
      <label>Pesquisar</label>
      <input type="text" id="searchBox" class="control-slim" placeholder="Buscar..." onkeyup="window.filtrar()">
    </div>

    <div class="filter-group" style="width: 160px;">
      <label>Tipo</label>
      <select id="filterTipo" class="control-slim" onchange="window.filtrar()">
        <option value="TODOS">Todos</option>
        <option value="CERTIFICADO">Certificado</option>
        <option value="ATESTADO">Atestado</option>

      </select>
    </div>

    <div style="display: flex; align-items: flex-end;">
      <button class="btn btn-outline" onclick="window.limparFiltros()">LIMPAR</button>
    </div>
  </div>
</div>


        


        
        <div class="table-area">
            <table id="homologTable">
                <thead>
                    <tr>
                        <th style="width: 30%;">Colaborador</th>
                        <th style="width: 30%;">Compet√™ncia Alvo</th>
                        <th style="width: 15%;">Tipo</th>
                        <th style="width: 15%;">Data</th>
                        <th style="width: 5%;">Nota</th>
                        <th style="text-align: right; width: 5%;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="view-formulario">
        <div class="form-layout" id="formWrapper">
            <aside class="form-sidebar">
                <div>
                    <span class="field-label">1. Benefici√°rio</span>
                    <select id="selectColaborador" class="input-full"><option value="">Carregando...</option></select>
                </div>
                <div>
                    <span class="field-label">2. Compet√™ncia</span>
                    <select id="selectTreinamento" class="input-full"><option value="">Carregando...</option></select>
                </div>

                
<!-- Bot√µes de Tipo de Evid√™ncia (Substitua onde necess√°rio) -->
<div id="tipoBox" class="evidence-options" style="display: flex; flex-direction: column; gap: 12px;">
  
  <button class="evidence-card active" type="button" data-mode="certificado" onclick="window.selectMode('certificado')">
    <div class="icon-box" style="background: #e0e7ff; color: #4338ca;">
      üìÑ
    </div>
    <div class="text-box">
      <strong>Certificado de Treinamento</strong><br>
      <small>Curso realizado.</small>
    </div>
  </button>

  <button class="evidence-card" type="button" data-mode="atestado" onclick="window.selectMode('atestado')">

    <div class="icon-box" style="background: #fef3c7; color: #92400e;">
      ‚úîÔ∏è
    </div>
    <div class="text-box">
      <strong>Atestado T√©cnico</strong>
<small>Valida√ß√£o por experi√™ncia profissional.</small>

    </div>
  </button>

</div>

                
            </aside>

            <main class="form-main">
                <div class="form-card">
                    <h2 id="form-title" style="margin: 0 0 24px 0; font-size: 18px; font-weight: 800; border-bottom: 2px solid var(--bg); padding-bottom: 10px;">Ficha de Registro</h2>

                    <div id="form-certificado">
                        <div style="display: flex; gap: 16px;">
                            <div style="flex: 1;">
                                <span class="field-label">Institui√ß√£o</span>
                                <input type="text" id="certInstituicao" class="input-full" value="Edesoft-Academy" readonly>
                                <label style="display:flex; align-items:center; gap:5px; font-size:11px; margin-top:-10px;">
                                    <input type="checkbox" id="checkEdesoft" checked onchange="window.toggleInstituicao(this.checked)"> Edesoft Academy
                                </label>
                            </div>
                            <div style="width: 150px;">
                                <span class="field-label">Data de Conclus√£o</span>
                                <input type="date" id="certData" class="input-full">
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; margin-top: 15px;">
                            <div style="width: 100px;">
                                <span class="field-label">Nota</span>
                                <input type="number" id="certNota" class="input-full" placeholder="N/A" readonly step="0.1">
                                <label style="display:flex; align-items:center; gap:5px; font-size:11px; margin-top:-10px;">
                                    <input type="checkbox" id="checkNotaNA" checked onchange="window.toggleNota(this.checked)"> N/A
                                </label>
                            </div>
                            <div style="flex: 1;">
                                <span class="field-label">Link do Certificado (URL)</span>
                                <input type="url" id="certLink" class="input-full" placeholder="https://...">
                            </div>
                        </div>
                    </div>

                    <div id="form-atestado" style="display: none;">
                        <span class="field-label">Justificativa do RH</span>
                        <textarea id="atestadoJustificativa" class="input-full" style="height: 120px;" placeholder="Detalhes da valida√ß√£o..."></textarea>
                        <span class="field-label">Aprovador T√©cnico</span>
                        <input type="text" id="atestadoAprovador" class="input-full" placeholder="Nome do gestor respons√°vel">
                        <div id="rhCheckRow" style="background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="checkRH" style="width: 18px; height: 18px;">
                            <span style="font-size: 11px; font-weight: 700;">REGISTRO VALIDADO CONFORME POL√çTICA INTERNA.</span>
                        </div>
                    </div>

                    <div class="footer">
                        <button class="btn btn-outline" onclick="window.voltarParaLista()">CANCELAR</button>
                        <button class="btn btn-primary" id="btnSalvar" onclick="window.salvarHomologacao()">GRAVAR DADOS</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { DBHandler } from '../bd-treinamentos/db-handler.js';
        let DADOS_LISTA = [];
        let currentId = null;
        let currentMode = 'CERTIFICADO';

// Fun√ß√£o para garantir que null, "" e undefined sejam tratados como iguais
const normalizar = (val) => {
    if (val === null || val === undefined || String(val).trim() === "") return null;
    return String(val).trim();
};
        
        // --- SETUP ---
        document.addEventListener('DOMContentLoaded', async () => {
            const session = JSON.parse(localStorage.getItem('rh_session')) || { role: 'VIEWER' };
            if (session.role === 'ADMIN') document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
            await carregarCombos();
            await window.carregarLista();
        });

        async function carregarCombos() {
            try {
                const colabs = await DBHandler.listarColaboradores({ somenteAtivos: true });
                document.getElementById('selectColaborador').innerHTML = '<option value="">Selecione...</option>' + 
                    colabs.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                const { treinamentos } = await DBHandler.carregarDadosIniciais();
                document.getElementById('selectTreinamento').innerHTML = '<option value="">Selecione...</option>' + 
                    treinamentos.map(t => `<option value="${t.id}">${t.nome}</option>`).join('');
            } catch (e) { console.error(e); }
        }

        // --- NAVEGA√á√ÉO SPA ---
let DADO_ORIGINAL = null; // Vari√°vel global no topo do script

window.abrirFormulario = async (id = null, visualizar = false) => {
    currentId = id;
    if (id) {
        const dado = await DBHandler.buscarHomologacaoPorId(id);
        DADO_ORIGINAL = JSON.parse(JSON.stringify(dado)); // Guarda uma c√≥pia limpa do original
        preencherCampos(dado);
        travarCampos(visualizar);
                document.getElementById('form-title').textContent = visualizar ? 'CONSULTA DE REGISTRO' : 'EDI√á√ÉO DE REGISTRO';
} else {
        DADO_ORIGINAL = null;
        limparFormulario();
                travarCampos(false);
                document.getElementById('form-title').textContent = 'NOVO REGISTRO';
            }
            document.getElementById('view-lista').classList.remove('active');
            document.getElementById('view-formulario').classList.add('active');
        };

        window.voltarParaLista = () => {
            document.getElementById('view-formulario').classList.remove('active');
            document.getElementById('view-lista').classList.add('active');
            window.carregarLista();
        };

        // --- DASHBOARD ---
        window.carregarLista = async () => {
            DADOS_LISTA = await DBHandler.listarHomologacoes();
            renderizarTabela(DADOS_LISTA);
        };



function renderizarTabela(lista) {
    const tbody = document.querySelector("#homologTable tbody");
    const session = JSON.parse(localStorage.getItem('rh_session')) || {};
    
    tbody.innerHTML = lista.map(item => `
        <tr>
            <td><strong>${item.colaboradores?.nome || '‚Äî'}</strong></td>
            <td>${item.treinamentos?.nome || '‚Äî'}</td>
            <td>
<span class="badge ${item.atividade_externa === 'ATESTADO' ? 'type-atestado' : 'type-cert'}">
  ${item.atividade_externa}
</span>

            </td>
            <td>${item.data_homologacao ? new Date(item.data_homologacao).toLocaleDateString('pt-BR') : '‚Äî'}</td>
            <td>${item.nota || '‚Äî'}</td>

            
<td style="text-align: right; white-space: nowrap;">
  <button class="btn-action btn-view" title="Visualizar" onclick="window.abrirFormulario(${item.id}, true)">
    <i class="fas fa-eye"></i>
  </button>

  <button class="btn-action" 
    style="background: #f8fafc; color: #1e293b; border: 1px solid #cbd5e1;" 
    onclick="${item.atividade_externa === 'ATESTADO' ? `window.gerarAtestado(${item.id})` : `window.gerarCertificado(${item.id})`}">
    <i class="fas ${item.atividade_externa === 'ATESTADO' ? 'fa-file-alt' : 'fa-certificate'}"></i>
  </button>

  ${session.role === 'ADMIN' ? `
    <button class="btn-action btn-edit" onclick="window.abrirFormulario(${item.id}, false)">
      <i class="fas fa-pen"></i>
    </button>
    <button class="btn-action btn-delete" onclick="window.deletarRegistro(${item.id})">
      <i class="fas fa-trash"></i>
    </button>
  ` : ''}
</td>



            
        </tr>
    `).join('');
}



        

        window.filtrar = () => {
            const busca = document.getElementById('searchBox').value.toLowerCase();
            const tipo = document.getElementById('filterTipo').value;
            renderizarTabela(DADOS_LISTA.filter(i =>
                ((i.colaboradores?.nome || "").toLowerCase().includes(busca) ||
                 (i.treinamentos?.nome || "").toLowerCase().includes(busca)) &&
                (tipo === 'TODOS' || i.atividade_externa === tipo)
            ));
        };

        window.limparFiltros = () => {
            document.getElementById('searchBox').value = "";
            document.getElementById('filterTipo').value = "TODOS";
            renderizarTabela(DADOS_LISTA);
        };

        // --- L√ìGICA FORMUL√ÅRIO ---
        window.selectMode = (mode) => {
  currentMode = mode.toUpperCase();

  // Ativa apenas o bot√£o correspondente
  document.querySelectorAll('.evidence-card').forEach(btn => {
    const isActive = btn.dataset.mode === mode;
    btn.classList.toggle('active', isActive);
  });

  // Alterna o formul√°rio
  document.getElementById('form-certificado').style.display = mode === 'certificado' ? 'block' : 'none';
  document.getElementById('form-atestado').style.display = mode === 'atestado' ? 'block' : 'none';

};


        window.toggleInstituicao = (check) => {
            const input = document.getElementById('certInstituicao');
            input.value = check ? "Edesoft-Academy" : "";
            input.readOnly = check;
        };

        window.toggleNota = (check) => {
            const input = document.getElementById('certNota');
            input.readOnly = check;
            input.placeholder = check ? "N/A" : "0.0";
            if (check) input.value = "";
        };

window.salvarHomologacao = async () => {
    const session = JSON.parse(localStorage.getItem('rh_session'));
    const btn = document.getElementById('btnSalvar');

    // Fun√ß√£o interna para tratar null, undefined e "" como id√™nticos na compara√ß√£o
    const normalizar = (v) => (v === null || v === undefined || String(v).trim() === "" ? null : String(v).trim());

    // 1. Captura dos novos valores do formul√°rio
    const payload = {
        colaborador_id: document.getElementById('selectColaborador').value,
        treinamento_id: document.getElementById('selectTreinamento').value,
        atividade_externa: currentMode,
        data_homologacao: currentMode === 'CERTIFICADO' ? document.getElementById('certData').value : new Date().toISOString().split('T')[0],
        nota: (currentMode === 'CERTIFICADO' && !document.getElementById('checkNotaNA').checked) ? document.getElementById('certNota').value : null,
        instrutor: currentMode === 'CERTIFICADO' ? document.getElementById('certInstituicao').value : document.getElementById('atestadoAprovador').value,
        observacoes: currentMode === 'ATESTADO' ? document.getElementById('atestadoJustificativa').value : document.getElementById('certLink').value
    };

    try {
        let detalhesLog = "";
        let houveAlteracaoReal = false;

        if (currentId && typeof DADO_ORIGINAL !== 'undefined' && DADO_ORIGINAL) {
            const alteracoes = [];
            
            // Mapeamento de campos t√©cnicos para nomes leg√≠veis no log
            const camposParaComparar = {
                'instrutor': 'Origem/Instrutor',
                'nota': 'Nota',
                'data_homologacao': 'Data',
                'atividade_externa': 'Tipo',
                'observacoes': 'Observa√ß√µes/Link'
            };

            for (let chave in camposParaComparar) {
                // Compara valores normalizados
                const vAntigo = normalizar(DADO_ORIGINAL[chave]);
                const vNovo = normalizar(payload[chave]);

                if (vAntigo !== vNovo) {
                    alteracoes.push(`${camposParaComparar[chave]}: [${vAntigo || 'vazio'}] ‚ûî [${vNovo || 'vazio'}]`);
                    houveAlteracaoReal = true;
                }
            }

            detalhesLog = houveAlteracaoReal 
                ? `Edi√ß√£o de Registro:\n${alteracoes.join('\n')}` 
                : "Edi√ß√£o salva sem altera√ß√£o de valores.";
        } else {
            detalhesLog = `Cria√ß√£o de novo registro para o Colaborador ID: ${payload.colaborador_id}`;
            houveAlteracaoReal = true;
        }

        // Feedback visual e trava de seguran√ßa
        if (btn) {
            btn.disabled = true;
            btn.textContent = "Gravando...";
        }

        // 1. Grava no Banco de Dados
        await DBHandler.salvarHomologacao({ ...(currentId ? { id: currentId } : {}), ...payload, usuario_registro: session.user });

        // 2. Grava o Log de Auditoria (apenas se for novo ou se algo mudou de fato)
        if (houveAlteracaoReal || !currentId) {
            await DBHandler.registrarLog(
                session.user, 
                currentId ? "ALTERA√á√ÉO_CERTIFICADO" : "INSER√á√ÉO_CERTIFICADO", 
                detalhesLog, 
                "Gest√£o de Certifica√ß√µes"
            );
        }

        alert("‚úÖ Registro e log processados com sucesso!");
        window.voltarParaLista();

    } catch (e) {
        alert("Erro ao processar: " + e.message);
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.textContent = "GRAVAR DADOS";
        }
    }
};

        window.deletarRegistro = async (id) => {
            if (!confirm('Excluir permanentemente?')) return;
            try { await DBHandler.excluirHomologacao(id); await window.carregarLista(); } catch (e) { alert(e.message); }
        };

        function preencherCampos(d) {
            document.getElementById('selectColaborador').value = d.colaborador_id;
            document.getElementById('selectTreinamento').value = d.treinamento_id;
if (d.atividade_externa === 'ATESTADO') {
    window.selectMode('atestado');
                document.getElementById('atestadoJustificativa').value = d.observacoes || "";
                document.getElementById('atestadoAprovador').value = d.instrutor || "";
            } else {
                window.selectMode('certificado', document.getElementById('btn-cert'));
                document.getElementById('certInstituicao').value = d.instrutor;
                document.getElementById('checkEdesoft').checked = (d.instrutor === "Edesoft-Academy");
                document.getElementById('certData').value = d.data_homologacao;
                document.getElementById('certLink').value = d.observacoes || "";
                if(d.nota) { document.getElementById('checkNotaNA').checked = false; window.toggleNota(false); document.getElementById('certNota').value = d.nota; }
            }
        }

        function travarCampos(travar) {
            document.querySelectorAll('#view-formulario input, #view-formulario select, #view-formulario textarea').forEach(el => el.disabled = travar);
            document.getElementById('btnSalvar').style.display = travar ? 'none' : 'inline-flex';
            document.getElementById('rhCheckRow').style.display = travar ? 'none' : 'flex';
            document.getElementById('tipoBox').style.pointerEvents = travar ? 'none' : 'auto';
            document.getElementById('formWrapper').classList.toggle('readonly-mode', travar);
        }

        function limparFormulario() {
            document.querySelectorAll('#view-formulario input, #view-formulario select, #view-formulario textarea').forEach(el => el.value = "");
            document.getElementById('certInstituicao').value = "Edesoft-Academy";
            document.getElementById('checkEdesoft').checked = true;
            document.getElementById('checkNotaNA').checked = true;
            document.getElementById('certData').value = new Date().toISOString().split('T')[0];
            window.selectMode('certificado', document.getElementById('btn-cert'));
        }



window.gerarCertificado = (id) => {
    const item = DADOS_LISTA.find(i => i.id === id);
    if (!item) return alert("Registro n√£o encontrado.");

    const nomeColaborador = item.colaboradores?.nome || "Colaborador";
    const nomeCurso = item.treinamentos?.nome || "Curso de Especializa√ß√£o";
    
    // CARGA HOR√ÅRIA: Preparado para o banco, usando 40h como padr√£o fict√≠cio
    const cargaHoraria = item.treinamentos?.carga_horaria || "40"; 
    
    const dataEmissao = item.data_homologacao 
        ? new Date(item.data_homologacao).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' }) 
        : new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

    const hashUnico = `ED-${item.id}-${new Date().getFullYear()}-CERT`;
    const janelaCertificado = window.open('', '_blank');
    
    janelaCertificado.document.write(`
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <title>Certificado - ${nomeColaborador}</title>
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Pinyon+Script&display=swap" rel="stylesheet">
            <style>
                :root { 
                    --primary-dark: #0f172a; 
                    --accent-gold: #c5a059; 
                    --text-muted: #64748b; 
                }

                body { 
                    margin: 0; padding: 0; display: flex; justify-content: center; 
                    align-items: center; min-height: 100vh; background: #222; 
                    font-family: 'Montserrat', sans-serif; 
                }

                .cert-canvas { 
                    width: 297mm; height: 210mm; background: var(--primary-dark); 
                    position: relative; display: flex; align-items: center; 
                    justify-content: center; overflow: hidden; box-sizing: border-box; 
                }

                .cert-canvas::before { 
                    content: ""; position: absolute; inset: 0; 
                    background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.03) 1px, transparent 0); 
                    background-size: 35px 35px; 
                }

                .outer-title { 
                    position: absolute; top: 45px; color: white; font-weight: 900; 
                    font-size: 56px; text-transform: uppercase; letter-spacing: 12px; z-index: 2; 
                }

                .content-card { 
                    width: 86%; height: 60%; background: white; position: relative; 
                    display: flex; flex-direction: column; align-items: center; 
                    justify-content: space-between; padding: 60px 80px; box-sizing: border-box; z-index: 2; 
                }

                .content-card::after { 
                    content: ""; position: absolute; top: 15px; left: 15px; right: 15px; bottom: 15px; 
                    border: 1px solid var(--accent-gold); pointer-events: none; 
                }

                .student-name { 
                    font-family: 'Pinyon Script', cursive; font-size: 84px; 
                    color: var(--primary-dark); margin: 10px 0; 
                }

                .course-name { 
                    display: block; font-weight: 700; color: var(--primary-dark); 
                    font-size: 28px; text-transform: uppercase; margin-top: 10px; 
                }

                .cert-footer { width: 100%; display: flex; justify-content: space-between; align-items: flex-end; }
                .info-block { width: 250px; text-align: left; }
                .info-label { font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
                .info-value { font-size: 15px; font-weight: 600; color: var(--primary-dark); border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }

                .seal-container { width: 110px; height: 110px; }

                .platform-signature { text-align: right; width: 300px; }
                .platform-name { font-weight: 900; font-size: 20px; color: var(--primary-dark); letter-spacing: 1px; margin-bottom: 4px; }
                .platform-badge { font-size: 10px; color: var(--text-muted); line-height: 1.4; border-right: 4px solid var(--accent-gold); padding-right: 12px; }

                @media print { 
                    body { background: white; } 
                    @page { size: A4 landscape; margin: 0; } 
                    .cert-canvas { -webkit-print-color-adjust: exact; width: 297mm; height: 210mm; } 
                }
            </style>
        </head>
        <body onload="setTimeout(() => window.print(), 500)">
            <div class="cert-canvas">
                <h1 class="outer-title">Certificado</h1>
                <div class="content-card">
                    <span style="font-weight:700; color:var(--text-muted); text-transform:uppercase; font-size:14px; letter-spacing:4px;">Certificamos que</span>
                    
                    <div class="student-name">${nomeColaborador}</div>
                    
                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                        <p style="color:var(--text-muted); font-size:19px; line-height:1.6; max-width:750px; margin:0 auto;">
                            concluiu com √™xito o treinamento de capacita√ß√£o em:
                            <span class="course-name">${nomeCurso}</span>
                            <span style="font-size: 15px; font-weight: 700; color: var(--accent-gold); margin-top: 12px; display: block; letter-spacing: 1px;">
                                CARGA HOR√ÅRIA: ${cargaHoraria} HORAS
                            </span>
                        </p>
                    </div>

                    <div class="cert-footer">
                        <div class="info-block">
                            <div class="info-value">${dataEmissao}</div>
                            <div class="info-label">Data de Emiss√£o</div>
                        </div>

                        <div class="seal-container">
                            <svg viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#c5a059" stroke-width="2"/>
                                <path id="txtP" fill="none" d="M 50,50 m -33,0 a 33,33 0 1,1 66,0 a 33,33 0 1,1 -66,0" />
                                <text font-size="6.5" font-weight="700" fill="#c5a059">
                                    <textPath xlink:href="#txtP">EDESOFT ACADEMY ‚Ä¢ OFFICIAL VERIFIED DOCUMENT ‚Ä¢</textPath>
                                </text>
                                <path d="M42 50 L48 56 L58 44" fill="none" stroke="#c5a059" stroke-width="3" stroke-linecap="round"/>
                            </svg>
                        </div>

                        <div class="platform-signature">
                            <div class="platform-name">EDESOFT ACADEMY</div>
                            <div class="platform-badge">
                                Documento emitido pela <strong>Plataforma Edesoft Academy</strong>.<br>
                                Autenticidade validada via registros digitais.<br>
                                <strong>C√≥digo: ${hashUnico}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="position:absolute; bottom:20px; width: 100%; text-align: center; color:rgba(255,255,255,0.2); font-size:9px; font-family:monospace; letter-spacing:1px;">
                    VERIFICATION HASH: ${btoa(hashUnico).substring(0, 16).toUpperCase()}
                </div>
            </div>
        </body>
        </html>
    `);
    janelaCertificado.document.close();
};




window.gerarAtestado = (id) => {
    const item = DADOS_LISTA.find(i => i.id === id);
    if (!item) return alert("Registro n√£o encontrado.");

    const nomeColaborador = item.colaboradores?.nome || "Colaborador";
    const nomeCurso = item.treinamentos?.nome || "Compet√™ncia T√©cnica";
    const dataEmissao = item.data_homologacao 
        ? new Date(item.data_homologacao).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' }) 
        : new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

    const justificativa = item.observacoes || "Experi√™ncia pr√°tica comprovada no exerc√≠cio das fun√ß√µes.";
    const hashUnico = `ED-VAL-${item.id}-${new Date().getFullYear()}`;

    // --- DETEC√á√ÉO DE G√äNERO CORRIGIDA ---
    const generoRaw = String(item.colaboradores?.genero || "").trim().toUpperCase();
    const isFeminino =
        generoRaw === "F" ||
        generoRaw === "FEMININO" ||
        generoRaw === "MULHER";

    let textoPrincipalHTML = "";

    if (isFeminino) {
        textoPrincipalHTML = `
            <div class="text-body">
                Declaramos para os devidos fins que a <b>colaboradora ${nomeColaborador}</b> teve sua experi√™ncia profissional 
                validada pela plataforma <b>Edesoft Academy</b>, demonstrando profici√™ncia pr√°tica integral nos temas abordados pelo treinamento:
                <br><br>
                <span style="font-size: 20px; font-weight: 800; color: var(--slate-900); letter-spacing: 1px;">${nomeCurso.toUpperCase()}</span>
                <br><br>
                Esta valida√ß√£o reconhece que o hist√≥rico profissional da colaboradora supre a necessidade de realiza√ß√£o do curso supracitado, 
                conferindo-lhe o status de <b>Habilitada</b> por equival√™ncia de fun√ß√µes.
            </div>`;
    } else {
        textoPrincipalHTML = `
            <div class="text-body">
                Declaramos para os devidos fins que o <b>colaborador ${nomeColaborador}</b> teve sua experi√™ncia profissional 
                validada pela plataforma <b>Edesoft Academy</b>, demonstrando profici√™ncia pr√°tica integral nos temas abordados pelo treinamento:
                <br><br>
                <span style="font-size: 20px; font-weight: 800; color: var(--slate-900); letter-spacing: 1px;">${nomeCurso.toUpperCase()}</span>
                <br><br>
                Esta valida√ß√£o reconhece que o hist√≥rico profissional do colaborador supre a necessidade de realiza√ß√£o do curso supracitado, 
                conferindo-lhe o status de <b>Habilitado</b> por equival√™ncia de fun√ß√µes.
            </div>`;
    }

    const janelaAtestado = window.open('', '_blank');

    janelaAtestado.document.write(`
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <title>Atestado - ${nomeColaborador}</title>
            <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800;900&display=swap" rel="stylesheet">
            <style>
                :root { --slate-900: #0f172a; --gold: #c5a059; --gray-muted: #64748b; }
                body { margin: 0; padding: 0; display: flex; justify-content: center; align-items: flex-start; background: #f1f5f9; font-family: 'Montserrat', sans-serif; }
                .canvas { 
                    width: 297mm; height: 190mm; background: #fff; position: relative; 
                    display: flex; flex-direction: column; padding: 30px 50px; box-sizing: border-box; border: 1px solid #e2e8f0;
                }
                .canvas::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 10px; background: var(--slate-900); }
                .header { border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; margin-bottom: 20px; }
                .header p { font-size: 10px; font-weight: 800; color: var(--gray-muted); text-transform: uppercase; margin: 0; letter-spacing: 2px; }
                .header h1 { font-size: 26px; font-weight: 900; color: var(--slate-900); margin: 0; text-transform: uppercase; }
                .text-body { font-size: 17px; color: #334155; line-height: 1.3; text-align: justify; margin-bottom: 14px; }
                .text-body b { color: var(--slate-900); }
                .parecer-box { background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0; padding: 8px 16px; margin: 12px 0; font-size: 13px; color: #475569; }
                .parecer-box b { font-size: 10px; text-transform: uppercase; color: var(--gray-muted); display: block; margin-bottom: 3px; }
                .footer { margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end; padding-top: 20px; border-top: 1px solid #f1f5f9; }
                .footer-col { width: 250px; }
                .f-label { font-size: 9px; font-weight: 700; color: var(--gray-muted); text-transform: uppercase; margin-bottom: 3px; }
                .f-value { font-size: 13px; font-weight: 700; color: var(--slate-900); border-bottom: 1px solid #e2e8f0; padding-bottom: 3px; white-space: nowrap; }
                .seal-svg { width: 80px; height: 80px; }
                .signature-box { text-align: right; width: 300px; }
                .platform-name { font-weight: 900; font-size: 17px; color: var(--slate-900); letter-spacing: 1px; margin-bottom: 3px; }
                .platform-badge { font-size: 9px; color: var(--gray-muted); line-height: 1.3; border-right: 4px solid var(--gold); padding-right: 12px; }
                @media print { 
                    body { background: white; } 
                    @page { size: A4 landscape; margin: 0; } 
                    .canvas { height: 190mm !important; padding: 16px 50px !important; border: none !important; -webkit-print-color-adjust: exact; } 
                }
            </style>
        </head>
        <body onload="window.print()">
            <div class="canvas">
                <div class="header">
                    <p>Edesoft Academy // Gest√£o de Talentos</p>
                    <h1>Atestado de Equival√™ncia T√©cnica</h1>
                </div>

                ${textoPrincipalHTML}

                <div class="parecer-box">
                    <b>Parecer de Homologa√ß√£o:</b>
                    "${justificativa}"
                </div>

                <div class="footer">
                    <div class="footer-col">
                        <div class="f-value">S√£o Paulo, ${dataEmissao}</div>
                        <div class="f-label">Data de Emiss√£o</div>
                    </div>

                    <div class="seal-svg">
                        <svg viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#c5a059" stroke-width="2"/>
                            <path id="pathT" fill="none" d="M 50,50 m -33,0 a 33,33 0 1,1 66,0 a 33,33 0 1,1 -66,0" />
                            <text font-size="6.5" font-weight="700" fill="#c5a059">
                                <textPath xlink:href="#pathT">EDESOFT ACADEMY ‚Ä¢ OFFICIAL VALIDATION ‚Ä¢ VERIFIED</textPath>
                            </text>
                            <path d="M42 50 L48 56 L58 44" fill="none" stroke="#c5a059" stroke-width="3" stroke-linecap="round"/>
                        </svg>
                    </div>

                    <div class="signature-box">
                        <div class="platform-name">EDESOFT ACADEMY</div>
                        <div class="platform-badge">
                            Validado via <strong>Edesoft Management System</strong>.<br>
                            ID de Autenticidade: <strong>${hashUnico}</strong><br>
                            Valida√ß√£o t√©cnica confirmada eletronicamente.
                        </div>
                    </div>
                </div>

                <div style="position:absolute; bottom:12px; width: 100%; left:0; text-align: center; color:#cbd5e1; font-size:9px; font-family:monospace; opacity: 0.6;">
                    VERIFICATION HASH: ${btoa(hashUnico).substring(0, 24).toUpperCase()}
                </div>
            </div>
        </body>
        </html>
    `);

    janelaAtestado.document.close();
};


        
        
        
    </script>
</body>
</html>








































