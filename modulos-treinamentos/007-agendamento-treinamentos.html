<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Treinamentos</title>
    
    <link rel="stylesheet" href="../estilos-treinamentos/catalogo-style.css">
    
    <style>
        /* =========================================
           Estilos Espec√≠ficos da Tela de Agendamento
           ========================================= */
        .layout-agendamento {
            display: grid;
            grid-template-columns: 1fr 2fr; /* Coluna do form menor, agenda maior */
            gap: 2rem;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .panel {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .panel h2 {
            margin-top: 0;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            color: #1e293b;
            font-size: 1.25rem;
        }

        /* --- Formul√°rio --- */
        .form-group { margin-bottom: 1rem; }
        
        .form-label { 
            display: block; 
            margin-bottom: 0.5rem; 
            font-weight: 600; 
            color: #475569; 
            font-size: 0.9rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #cbd5e1; 
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            background-color: #f8fafc;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #2563eb;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        .btn-primary-full { 
            width: 100%; 
            padding: 1rem; 
            background-color: #2563eb; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: background 0.2s, transform 0.1s; 
            margin-top: 10px;
        }
        
        .btn-primary-full:hover { background-color: #1d4ed8; }
        .btn-primary-full:active { transform: translateY(1px); }
        .btn-primary-full:disabled { background-color: #94a3b8; cursor: not-allowed; }

        /* --- Agenda Visual --- */
        .agenda-list { list-style: none; padding: 0; margin: 0; }
        
        .agenda-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background: #fff;
            border-left: 5px solid #2563eb; /* Cor padr√£o Agendado */
            transition: transform 0.2s;
        }
        
        .agenda-item:hover { transform: translateX(2px); border-color: #cbd5e1; }

        .agenda-date {
            flex-basis: 80px;
            text-align: center;
            font-weight: 700;
            color: #334155;
            line-height: 1.2;
            background: #f1f5f9;
            padding: 8px;
            border-radius: 6px;
        }
        
        .agenda-date span { 
            display: block; 
            font-size: 0.8rem; 
            color: #64748b; 
            font-weight: 600; 
            margin-top: 4px;
        }

        .agenda-details { flex: 1; margin-left: 1.5rem; }
        .agenda-details h4 { margin: 0; color: #1e293b; font-size: 1rem; }
        .agenda-details p { margin: 0.25rem 0 0; color: #64748b; font-size: 0.9rem; }

        .agenda-status {
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-agendado { background: #dbeafe; color: #1e40af; }
        .status-realizado { background: #dcfce7; color: #166534; }
        .status-cancelado { background: #fee2e2; color: #991b1b; }
        
        .loading-spinner { text-align: center; padding: 2rem; color: #64748b; font-style: italic; }

        @media (max-width: 768px) {
            .layout-agendamento { grid-template-columns: 1fr; gap: 1rem; padding: 1rem; }
            .agenda-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .agenda-date { width: 100%; flex-basis: auto; display: flex; justify-content: space-between; align-items: center; }
            .agenda-date span { margin-top: 0; }
            .agenda-details { margin-left: 0; }
            .agenda-status { align-self: flex-start; }
        }
    </style>
</head>
<body style="background-color: #f8fafc;">

    <header style="background: white; padding: 1rem 2rem; border-bottom: 1px solid #e2e8f0;">
        <h1 style="margin: 0; font-size: 1.5rem; color: #0f172a; display: flex; align-items: center; gap: 10px;">
            üóìÔ∏è Agendamento de Treinamentos
        </h1>
    </header>

    <main class="layout-agendamento">
        
        <section class="panel">
            <h2>Novo Agendamento</h2>
            <form id="form-agendamento">
                <div class="form-group">
                    <label class="form-label">O qu√™? (Treinamento)</label>
                    <select id="select-treinamento" class="form-select" required>
                        <option value="">Carregando...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Quem? (Colaborador)</label>
                    <select id="select-colaborador" class="form-select" required>
                        <option value="">Carregando...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Quando? (Data e Hora)</label>
                    <input type="datetime-local" id="input-datahora" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Observa√ß√µes (Opcional)</label>
                    <textarea id="input-obs" class="form-textarea" rows="3" placeholder="Ex: Sala de reuni√µes 01"></textarea>
                </div>

                <button type="submit" id="btn-agendar" class="btn-primary-full">Confirmar Agendamento</button>
            </form>
        </section>

        <section class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Pr√≥ximos Treinamentos</h2>
                <button id="btn-refresh" style="background: none; border: none; cursor: pointer; color: #2563eb; font-size: 1.2rem;" title="Atualizar Lista">‚Üª</button>
            </div>
            
            <div id="loading-agenda" class="loading-spinner">Carregando agenda...</div>
            <ul id="lista-agenda" class="agenda-list" style="display: none;">
                </ul>
        </section>

    </main>

    <script type="module">
        import "../scripts-treinamentos/module-guard.js"; // Guard de seguran√ßa
        import { DBHandler } from "../bd-treinamentos/db-handler.js";

        // --- Elementos do DOM ---
        const formAgendamento = document.getElementById('form-agendamento');
        const selectTreino = document.getElementById('select-treinamento');
        const selectColab = document.getElementById('select-colaborador');
        const btnAgendar = document.getElementById('btn-agendar');
        const listaAgenda = document.getElementById('lista-agenda');
        const loadingAgenda = document.getElementById('loading-agenda');
        const btnRefresh = document.getElementById('btn-refresh');

        // --- Fun√ß√µes Utilit√°rias ---
        function formatarDataHoraVisual(isoString) {
            const data = new Date(isoString);
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const hora = String(data.getHours()).padStart(2, '0');
            const min = String(data.getMinutes()).padStart(2, '0');
            
            return {
                diaMes: `${dia}/${mes}`,
                ano: data.getFullYear(),
                hora: `${hora}:${min}`
            };
        }

        // --- Inicializa√ß√£o ---
        async function inicializarTela() {
            try {
                // 1. Carrega os selects em paralelo (Promise.all para performance)
                const [treinos, colaboradores] = await Promise.all([
                    DBHandler.listarTreinamentos(),
                    DBHandler.listarColaboradores({ somenteAtivos: true }) // Filtro opcional se implementado no handler
                ]);

                popularSelect(selectTreino, treinos, 'Selecione o Treinamento');
                popularSelect(selectColab, colaboradores, 'Selecione o Colaborador');

                // 2. Carrega a agenda
                await carregarAgenda();

            } catch (error) {
                console.error("Erro ao inicializar:", error);
                alert("Erro ao carregar dados. Verifique a conex√£o ou o console.");
            }
        }

        // Popula um <select> gen√©rico
        function popularSelect(elementoSelect, dados, placeholder) {
            elementoSelect.innerHTML = `<option value="">${placeholder}</option>`;
            if (!dados) return;

            // Ordena alfabeticamente
            dados.sort((a, b) => (a.nome || "").localeCompare(b.nome || ""));

            dados.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.nome;
                elementoSelect.appendChild(option);
            });
        }

        // Carrega e Renderiza a Agenda
        async function carregarAgenda() {
            loadingAgenda.style.display = 'block';
            listaAgenda.style.display = 'none';
            listaAgenda.innerHTML = '';

            try {
                // Chama a fun√ß√£o nova criada no db-handler.js
                const agendamentos = await DBHandler.listarAgendamentosFuturos();

                if (!agendamentos || agendamentos.length === 0) {
                    listaAgenda.innerHTML = '<li style="text-align:center; padding: 2rem; color: #64748b;">Nenhum agendamento futuro encontrado.</li>';
                } else {
                    agendamentos.forEach(item => {
                        const dataF = formatarDataHoraVisual(item.data_hora);
                        const statusClass = `status-${(item.status || 'AGENDADO').toLowerCase()}`;
                        
                        // Prote√ß√£o contra dados nulos (caso algu√©m exclua um curso mas o agendamento fique)
                        const nomeTreino = item.treinamento ? item.treinamento.nome : '(Treinamento Removido)';
                        const nomeColab = item.colaborador ? item.colaborador.nome : '(Colaborador Removido)';

                        const li = document.createElement('li');
                        li.className = `agenda-item ${statusClass}`;
                        li.innerHTML = `
                            <div class="agenda-date">
                                ${dataF.diaMes}
                                <span>${dataF.hora}</span>
                            </div>
                            <div class="agenda-details">
                                <h4>${nomeTreino}</h4>
                                <p>üë§ ${nomeColab}</p>
                            </div>
                            <span class="agenda-status ${statusClass}">${item.status || 'Agendado'}</span>
                        `;
                        listaAgenda.appendChild(li);
                    });
                }
            } catch (error) {
                console.error("Erro ao carregar agenda:", error);
                listaAgenda.innerHTML = '<li style="color: #ef4444; text-align: center; padding: 1rem;">Erro ao carregar agenda.</li>';
            } finally {
                loadingAgenda.style.display = 'none';
                listaAgenda.style.display = 'block';
            }
        }

        // --- Evento de Salvar ---
        formAgendamento.addEventListener('submit', async (e) => {
            e.preventDefault();

            const payload = {
                treinamento_id: selectTreino.value,
                colaborador_id: selectColab.value,
                data_hora: new Date(document.getElementById('input-datahora').value).toISOString(),
                observacoes: document.getElementById('input-obs').value || null,
                status: 'AGENDADO'
            };

            const btnTextoOriginal = btnAgendar.innerText;
            btnAgendar.innerText = 'Agendando...';
            btnAgendar.disabled = true;

            try {
                await DBHandler.criarAgendamento(payload);
                
                // Sucesso
                formAgendamento.reset();
                await carregarAgenda(); // Recarrega a lista
                alert("‚úÖ Agendamento realizado com sucesso!");

            } catch (error) {
                console.error("Erro ao agendar:", error);
                alert("Erro ao salvar agendamento:\n" + (error.message || error));
            } finally {
                btnAgendar.innerText = btnTextoOriginal;
                btnAgendar.disabled = false;
            }
        });
        
        // Bot√£o manual de atualizar
        btnRefresh.addEventListener('click', (e) => {
            e.preventDefault();
            carregarAgenda();
        });

        // Roda ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', inicializarTela);

    </script>
</body>
</html>
