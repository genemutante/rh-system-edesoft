<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Agenda | Enterprise</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* =================================================================
           RESET E LAYOUT
           ================================================================= */
        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            display: flex; flex-direction: column;
        }

        /* 1. TOOLBAR SUPERIOR */
        .top-controls {
            height: 64px;
            background: #ffffff;
            border-bottom: 1px solid #cbd5e1;
            display: flex; align-items: center; padding: 0 24px; gap: 20px;
            flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.03); z-index: 10;
        }

        .control-group { display: flex; flex-direction: column; gap: 3px; flex: 1; max-width: 350px; }
        .control-group label { font-size: 0.65rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }

        .input-toolbar, .btn-fake-input {
            height: 36px; padding: 0 10px; border: 1px solid #cbd5e1; border-radius: 6px;
            font-size: 0.85rem; color: #1e293b; background: #f8fafc;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: all 0.2s; width: 100%;
        }
        .input-toolbar:hover, .btn-fake-input:hover { background: #fff; border-color: #94a3b8; }
        .badge-count { background: #e2e8f0; color: #475569; font-size: 0.7rem; padding: 1px 6px; border-radius: 4px; font-weight: 600; }
        .btn-fake-input.active .badge-count { background: #dbeafe; color: #2563eb; }

        .btn-action-main {
            height: 38px; padding: 0 20px; background: #0f172a; color: #fff;
            border: none; border-radius: 6px; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; margin-left: auto; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .btn-action-main:hover { background: #1e293b; }
        .btn-action-main:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* =================================================================
           2. GRID DE GEST√ÉO (COM A√á√ïES)
           ================================================================= */
        .grid-container {
            flex: 1; overflow: hidden; padding: 20px;
            display: flex; flex-direction: column; gap: 10px;
        }

        .grid-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0;
        }
        .grid-filters { display: flex; gap: 10px; align-items: center; flex: 1; }
        
        .search-grid {
            padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.85rem; width: 220px;
        }
        .select-view-mode {
            padding: 6px 10px; border: 1px solid #2563eb; border-radius: 6px; font-size: 0.85rem; 
            background: #eff6ff; color: #1e40af; font-weight: 600; cursor: pointer;
        }

        .grid-wrapper {
            background: #fff; border: 1px solid #e2e8f0; border-radius: 8px;
            overflow: hidden; display: flex; flex-direction: column; flex: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .grid-scroll { flex: 1; overflow-y: auto; }

        table { width: 100%; border-collapse: collapse; text-align: left; }
        thead { position: sticky; top: 0; background: #f8fafc; z-index: 2; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        th { 
            padding: 10px 14px; font-size: 0.75rem; font-weight: 700; color: #64748b; 
            text-transform: uppercase; border-bottom: 1px solid #e2e8f0; background: #f1f5f9;
        }
        td { 
            padding: 8px 14px; border-bottom: 1px solid #f1f5f9; 
            font-size: 0.85rem; color: #334155; vertical-align: middle; 
        }
        tr:hover { background: #f8fafc; }

        /* Agrupamento */
        tr.group-row td {
            background-color: #eef2ff; color: #1e3a8a; font-weight: 700; font-size: 0.9rem;
            padding: 10px 14px; border-top: 1px solid #e0e7ff; border-bottom: 1px solid #e0e7ff;
        }
        .group-meta { font-weight: 400; font-size: 0.8rem; color: #6366f1; margin-left: 8px; }

        /* Bot√µes de A√ß√£o na Tabela */
        .actions-cell { display: flex; gap: 6px; justify-content: flex-end; }
        
        .btn-mini {
            width: 26px; height: 26px; display: inline-flex; align-items: center; justify-content: center;
            border: 1px solid transparent; border-radius: 4px; cursor: pointer; transition: all 0.1s;
            background: #fff; border-color: #e2e8f0; color: #64748b;
        }
        .btn-mini:hover { transform: scale(1.05); }
        
        .btn-check:hover { background: #dcfce7; border-color: #22c55e; color: #15803d; }
        .btn-miss:hover { background: #fee2e2; border-color: #ef4444; color: #b91c1c; }
        .btn-trash:hover { background: #f1f5f9; border-color: #94a3b8; color: #0f172a; }

        /* Status Badges */
        .tag-status { 
            font-size: 0.65rem; font-weight: 700; padding: 3px 8px; border-radius: 12px; 
            text-transform: uppercase; display: inline-block; min-width: 80px; text-align: center;
        }
        
        .st-agendado { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; }
        .st-realizado { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .st-falta { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }

        /* =================================================================
           3. MODAIS (Padr√£o)
           ================================================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(2px);
            z-index: 100; display: none; align-items: center; justify-content: center;
        }
        .modal-card {
            width: 800px; max-width: 95vw; height: 85vh;
            background: #fff; border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .modal-header { padding: 14px 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex: 1; overflow-y: auto; padding: 0; background: #f8fafc; }
        .modal-footer { padding: 14px 20px; border-top: 1px solid #e2e8f0; background: #fff; display: flex; justify-content: flex-end; gap: 10px; }
        
        /* Tabela Cronograma */
        .cronograma-table { width: 100%; border-collapse: collapse; }
        .cronograma-table th { background: #e2e8f0; font-size: 0.7rem; text-align: left; padding: 8px 16px; }
        .cronograma-table td { padding: 8px 16px; border-bottom: 1px solid #e2e8f0; background: #fff; }
        .input-date-inline { border: 1px solid #cbd5e1; border-radius: 4px; padding: 6px; width: 100%; max-width: 200px; font-size: 0.85rem; }
        
        .selection-item { display: flex; align-items: center; padding: 10px 20px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .selection-item:hover { background: #eff6ff; }
        .selection-item input { margin-right: 12px; width: 16px; height: 16px; }

        .btn-cancel { padding: 8px 16px; border: 1px solid #cbd5e1; background: #fff; border-radius: 6px; cursor: pointer; font-weight: 600; color: #64748b; font-size: 0.85rem; }
        .btn-confirm { padding: 8px 16px; background: #2563eb; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
        .btn-apply { background: #3b82f6; color: #fff; border: none; border-radius: 4px; padding: 6px 12px; font-size: 0.8rem; cursor: pointer; }
        .bulk-actions { padding: 10px 20px; background: #eff6ff; border-bottom: 1px solid #dbeafe; display: flex; align-items: center; gap: 15px; }

    </style>
</head>
<body>

    <div class="top-controls">
        <div class="control-group" style="flex: 1.5;">
            <label>1. O Qu√™? (Curso)</label>
            <select id="sel-treino" class="input-toolbar" onchange="resetCronograma()">
                <option value="">Carregando...</option>
            </select>
        </div>
        <div class="control-group">
            <label>2. Quem? (Participantes)</label>
            <div class="btn-fake-input" onclick="abrirModalAlunos()">
                <span>Selecionar Alunos</span>
                <span id="badge-alunos" class="badge-count">0</span>
            </div>
        </div>
        <button id="btn-open-cronograma" class="btn-action-main" onclick="abrirCronograma()" disabled style="opacity: 0.5;">
            <span>3. Agendar Aulas</span>
        </button>
    </div>

    <div class="grid-container">
        
        <div class="grid-toolbar">
            <div class="grid-filters">
                <select id="grid-view-mode" class="select-view-mode" onchange="renderizarGrid()">
                    <option value="view_date">üìÖ Cronograma Di√°rio (Timeline)</option>
                    <option value="view_student">üë§ Vis√£o Aluno (Hist√≥rico)</option>
                    <option value="view_class">üìñ Por Conte√∫do (Chamada)</option>
                    <option value="view_course">üìö Por Curso (Turmas)</option>
                    <option value="view_list">üìã Lista Geral</option>
                </select>

                <input type="text" id="grid-search" class="search-grid" placeholder="Buscar aluno, curso ou data..." oninput="renderizarGrid()">
                
                <select id="grid-filter-status" class="search-grid" style="width: 150px;" onchange="renderizarGrid()">
                    <option value="">Todos Status</option>
                    <option value="AGENDADO">Agendados</option>
                    <option value="REALIZADO">Realizados</option>
                    <option value="FALTA">Faltas</option>
                </select>
            </div>
            <button onclick="carregarAgenda()" style="background:none; border:none; color:#2563eb; cursor:pointer; font-weight:600; font-size:0.85rem;">‚Üª Atualizar Dados</button>
        </div>
        
        <div class="grid-wrapper">
            <div class="grid-scroll">
                <table id="tabela-agenda">
                    <thead>
                        <tr>
                            <th style="width: 140px;">Data</th>
                            <th>Colaborador</th>
                            <th>Treinamento</th>
                            <th>Conte√∫do</th>
                            <th style="text-align:center;">Status</th>
                            <th style="text-align:right; padding-right:20px;">A√ß√µes (Chamada)</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-agenda">
                        </tbody>
                </table>
                <div id="loading-grid" style="padding:30px; text-align:center; color:#64748b; display:none;">Carregando dados...</div>
            </div>
        </div>
    </div>

    <div id="modal-alunos" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3>Selecionar Participantes</h3>
                <button onclick="fecharModal('modal-alunos')" style="background:none; border:none; cursor:pointer; font-size:1.5rem;">&times;</button>
            </div>
            <div style="padding: 10px 20px; border-bottom: 1px solid #e2e8f0;">
                <input type="text" id="search-alunos" placeholder="Buscar nome..." 
                       style="width:100%; padding: 8px; border:1px solid #cbd5e1; border-radius:6px;"
                       oninput="filtrarAlunos()">
            </div>
            <div class="modal-body">
                <ul id="lista-alunos" style="list-style:none; padding:0; margin:0;"></ul>
            </div>
            <div class="modal-footer">
                <span id="contador-alunos" style="margin-right:auto; color:#64748b; font-size:0.85rem;">0 selecionados</span>
                <button class="btn-confirm" onclick="fecharModal('modal-alunos')">Confirmar Sele√ß√£o</button>
            </div>
        </div>
    </div>

    <div id="modal-cronograma" class="modal-overlay">
        <div class="modal-card" style="width: 900px;">
            <div class="modal-header">
                <h3>Definir Datas das Aulas</h3>
                <button onclick="fecharModal('modal-cronograma')" style="background:none; border:none; cursor:pointer; font-size:1.5rem;">&times;</button>
            </div>
            <div class="bulk-actions">
                <label>Data em Massa:</label>
                <input type="datetime-local" id="bulk-date" style="border:1px solid #cbd5e1; border-radius:4px; padding:4px;">
                <button class="btn-apply" onclick="aplicarDataEmMassa()">Aplicar</button>
            </div>
            <div class="modal-body">
                <table class="cronograma-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" onclick="toggleTodasAulas(this.checked)"></th>
                            <th>Aula / M√≥dulo</th>
                            <th style="width: 220px;">Data de Realiza√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="lista-aulas-cronograma"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="fecharModal('modal-cronograma')">Cancelar</button>
                <button id="btn-salvar-final" class="btn-confirm" onclick="salvarAgendamentoFinal()">Confirmar Agendamento</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { DBHandler } from "../bd-treinamentos/db-handler.js";

        let todosCursos = [];
        let todosColabs = [];
        let alunosSelecionadosIds = new Set();
        let cursoAtual = null;
        let agendaCache = []; 

        document.addEventListener('DOMContentLoaded', async () => {
            await carregarDados();
            await carregarAgenda();
        });

        async function carregarDados() {
            try {
                const [treinos, colabs] = await Promise.all([
                    DBHandler.listarTreinamentos(),
                    DBHandler.listarColaboradores({ somenteAtivos: true })
                ]);
                todosCursos = treinos || [];
                todosColabs = colabs || [];

                const selTreino = document.getElementById('sel-treino');
                selTreino.innerHTML = '<option value="">Selecione...</option>';
                todosCursos.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(t => {
                    selTreino.innerHTML += `<option value="${t.id}">${t.nome}</option>`;
                });
                renderizarListaAlunos();
            } catch (e) { console.error(e); }
        }

        // =========================================================
        // MOTOR DE VISUALIZA√á√ÉO (SMART GRID)
        // =========================================================
        
        window.carregarAgenda = async function() {
            const loading = document.getElementById('loading-grid');
            loading.style.display = 'block';
            document.getElementById('tbody-agenda').innerHTML = '';

            try {
                // NOTA: Certifique-se de que atualizou o db-handler.js para ter listarAgendamentos()
                // Se n√£o atualizou, ele vai tentar chamar listarAgendamentosFuturos e vai falhar ou trazer s√≥ futuro.
                if (DBHandler.listarAgendamentos) {
                    agendaCache = await DBHandler.listarAgendamentos();
                } else {
                    // Fallback se voc√™ esqueceu de atualizar o JS do banco
                    agendaCache = await DBHandler.listarAgendamentosFuturos();
                }
                
                renderizarGrid();
            } catch (e) {
                console.error(e);
                alert("Erro ao carregar dados. Verifique se atualizou o db-handler.js");
            } finally {
                loading.style.display = 'none';
            }
        };

        window.renderizarGrid = function() {
            const tbody = document.getElementById('tbody-agenda');
            const termo = document.getElementById('grid-search').value.toLowerCase();
            const viewMode = document.getElementById('grid-view-mode').value;
            const statusFilter = document.getElementById('grid-filter-status').value;

            tbody.innerHTML = '';

            if (!agendaCache || agendaCache.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#94a3b8;">Nenhum agendamento encontrado.</td></tr>';
                return;
            }

            // 1. Filtragem Global (Texto + Status)
            let lista = agendaCache.filter(item => {
                const txt = (item.colaborador?.nome + ' ' + item.treinamento?.nome + ' ' + (item.aula?.titulo || '')).toLowerCase();
                const matchTexto = txt.includes(termo);
                const matchStatus = statusFilter ? item.status === statusFilter : true;
                return matchTexto && matchStatus;
            });

            // 2. Agrupamento Inteligente
            if (viewMode === 'view_list') {
                renderizarLinhas(lista, tbody);
            } else {
                const grupos = {};
                
                lista.forEach(item => {
                    let chave = '';
                    let ordem = ''; 

                    if (viewMode === 'view_date') {
                        const d = new Date(item.data_hora);
                        chave = d.toLocaleDateString('pt-BR', { weekday:'short', day:'2-digit', month:'2-digit', year:'numeric' });
                        ordem = item.data_hora; 
                    } 
                    else if (viewMode === 'view_course') {
                        chave = item.treinamento?.nome || 'Sem Curso';
                        ordem = chave;
                    }
                    else if (viewMode === 'view_student') {
                        chave = item.colaborador?.nome || 'Sem Aluno';
                        ordem = chave;
                    }
                    else if (viewMode === 'view_class') {
                        const nomeAula = item.aula ? item.aula.titulo : '(Curso Inteiro)';
                        const nomeCurso = item.treinamento?.nome || '';
                        chave = `${nomeAula} <span style='font-weight:400; color:#64748b; font-size:0.8rem;'>‚Äî ${nomeCurso}</span>`;
                        ordem = nomeAula;
                    }

                    // Chave composta para ordena√ß√£o correta de datas
                    const keyMap = viewMode === 'view_date' ? ordem.split('T')[0] + '||' + chave : chave;
                    
                    if (!grupos[keyMap]) grupos[keyMap] = { label: chave, items: [] };
                    grupos[keyMap].items.push(item);
                });

                // Ordena as chaves (Datas DESC ou Alfab√©tica)
                const keysOrdenadas = Object.keys(grupos).sort();
                if (viewMode === 'view_date') keysOrdenadas.reverse(); // Datas recentes primeiro

                keysOrdenadas.forEach(k => {
                    const grupo = grupos[k];
                    const trHeader = document.createElement('tr');
                    trHeader.className = 'group-row';
                    trHeader.innerHTML = `<td colspan="6">${grupo.label} <span class="group-meta">(${grupo.items.length})</span></td>`;
                    tbody.appendChild(trHeader);
                    renderizarLinhas(grupo.items, tbody);
                });
            }
        };

function renderizarLinhas(lista, container) {
            const agora = new Date(); // Pega a data e hora exata de agora

            // Ordena: Data mais recente primeiro
            lista.sort((a,b) => new Date(b.data_hora) - new Date(a.data_hora));

            lista.forEach(item => {
                const dataItem = new Date(item.data_hora);
                
                // Formata√ß√£o da data para o Brasil
                const dataFmt = dataItem.toLocaleString('pt-BR', { 
                    day: '2-digit', month: '2-digit', 
                    hour: '2-digit', minute: '2-digit' 
                });

                const nomeAula = item.aula ? `${item.aula.ordem}. ${item.aula.titulo}` : 'Curso Completo';
                
                // --- L√ìGICA DE STATUS INTELIGENTE ---
                let labelStatus = item.status;
                let statusClass = 'st-agendado';
                let corTexto = '#2563eb'; // Azul padr√£o

                // Se j√° foi marcado como Realizado ou Falta no banco, respeita o banco
                if (item.status === 'REALIZADO') {
                    statusClass = 'st-realizado';
                    corTexto = '#15803d';
                } else if (item.status === 'FALTA') {
                    statusClass = 'st-falta';
                    corTexto = '#b91c1c';
                } else if (item.status === 'AGENDADO') {
                    // Se ainda est√° 'AGENDADO' no banco, verificamos a data
                    if (dataItem < agora) {
                        // PASSADO: Virou Falta automaticamente (Visualmente)
                        labelStatus = 'FALTA (N.C.)'; // N√£o Confirmado
                        statusClass = 'st-falta'; // Usa estilo de falta
                        corTexto = '#ea580c'; // Laranja escuro para diferenciar de falta expl√≠cita
                    } else {
                        // FUTURO: Continua Agendado
                        labelStatus = 'AGENDADO';
                    }
                }

                // --- BOT√ïES DE A√á√ÉO ---
                // Aparecem se for Agendado (Futuro) ou Falta N.C. (Passado n√£o tratado)
                let botoesHtml = '';
                
                // Bot√£o PRESEN√áA (Aparece se for Agendado ou Falta)
                // Se for passado, √© crucial para corrigir a falta autom√°tica
                if (item.status !== 'REALIZADO') {
                    botoesHtml += `
                        <button class="btn-mini btn-check" title="Aluno esteve presente" onclick="mudarStatus(${item.id}, 'REALIZADO')">
                            ‚úÖ
                        </button>
                    `;
                }
                
                // Bot√£o FALTA EXPL√çCITA (Opcional, j√° que o n√£o marcar vira falta, mas bom para travar o registro)
                if (item.status === 'AGENDADO' && dataItem < agora) {
                     botoesHtml += `
                        <button class="btn-mini btn-miss" title="Confirmar Falta no Banco" onclick="mudarStatus(${item.id}, 'FALTA')">
                            ‚ùå
                        </button>
                    `;
                }

                // Bot√£o EXCLUIR (Sempre dispon√≠vel)
                botoesHtml += `
                    <button class="btn-mini btn-trash" title="Excluir Agendamento" onclick="excluirAgendamento(${item.id})">
                        üóëÔ∏è
                    </button>
                `;

                const tr = document.createElement('tr');
                // Se for passado e n√£o realizado, deixa o fundo levemente avermelhado para chamar aten√ß√£o
                if (labelStatus.includes('FALTA')) {
                    tr.style.backgroundColor = '#fff7ed'; 
                }

                tr.innerHTML = `
                    <td style="font-weight:600; color:${dataItem < agora ? '#64748b' : '#1e293b'}">${dataFmt}</td>
                    <td>${item.colaborador?.nome || '-'}</td>
                    <td style="color:#64748b;">${item.treinamento?.nome || '-'}</td>
                    <td>${nomeAula}</td>
                    <td style="text-align:center;">
                        <span class="tag-status ${statusClass}" style="color:${corTexto}; border-color:${corTexto}40; background-color:${corTexto}10;">
                            ${labelStatus}
                        </span>
                    </td>
                    <td class="actions-cell">
                        ${botoesHtml}
                    </td>
                `;
                container.appendChild(tr);
            });
        }

        // --- A√á√ïES DO GRID ---
        window.mudarStatus = async function(id, novoStatus) {
            // Otimisticamente atualiza a UI local antes do banco
            const item = agendaCache.find(i => i.id === id);
            if(item) item.status = novoStatus;
            renderizarGrid(); // Renderiza r√°pido

            try {
                await DBHandler.atualizarStatusAgendamento(id, novoStatus);
            } catch(e) {
                alert("Erro ao salvar status: " + e.message);
                carregarAgenda(); // Reverte em caso de erro
            }
        };

        window.excluirAgendamento = async function(id) {
            if(!confirm("Tem certeza que deseja cancelar este agendamento?")) return;
            try {
                await DBHandler.supabaseClient.from('agendamentos').delete().eq('id', id);
                agendaCache = agendaCache.filter(i => i.id !== id);
                renderizarGrid();
            } catch(e) { alert("Erro: " + e.message); }
        };

        // --- L√ìGICA DE CRIA√á√ÉO (MODAIS) ---
        function renderizarListaAlunos() {
            const ul = document.getElementById('lista-alunos');
            ul.innerHTML = '';
            todosColabs.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(c => {
                const li = document.createElement('li');
                li.className = 'selection-item';
                li.innerHTML = `
                    <label style="display:flex; align-items:center; width:100%; cursor:pointer;">
                        <input type="checkbox" class="chk-aluno" value="${c.id}" style="margin-right:12px;">
                        <span style="font-size:0.9rem; color:#334155;">${c.nome}</span>
                        <span style="margin-left:auto; font-size:0.75rem; color:#94a3b8;">${c.departamento || '-'}</span>
                    </label>
                `;
                li.querySelector('input').onchange = (e) => {
                    if(e.target.checked) alunosSelecionadosIds.add(c.id);
                    else alunosSelecionadosIds.delete(c.id);
                    atualizarBadgeAlunos();
                };
                ul.appendChild(li);
            });
        }

        function atualizarBadgeAlunos() {
            const count = alunosSelecionadosIds.size;
            document.getElementById('badge-alunos').textContent = count;
            document.getElementById('contador-alunos').textContent = `${count} selecionados`;
            verificarHabilitarCronograma();
        }

        window.filtrarAlunos = function() {
            const termo = document.getElementById('search-alunos').value.toLowerCase();
            document.querySelectorAll('#lista-alunos li').forEach(li => {
                const texto = li.innerText.toLowerCase();
                li.style.display = texto.includes(termo) ? 'flex' : 'none';
            });
        };

        window.resetCronograma = () => verificarHabilitarCronograma();

        function verificarHabilitarCronograma() {
            const cursoId = document.getElementById('sel-treino').value;
            const temAlunos = alunosSelecionadosIds.size > 0;
            const btn = document.getElementById('btn-open-cronograma');
            if (cursoId && temAlunos) { btn.disabled = false; btn.style.opacity = '1'; }
            else { btn.disabled = true; btn.style.opacity = '0.5'; }
        }

        window.abrirCronograma = function() {
            const cursoId = document.getElementById('sel-treino').value;
            cursoAtual = todosCursos.find(c => String(c.id) === String(cursoId));
            const tbody = document.getElementById('lista-aulas-cronograma');
            tbody.innerHTML = '';
            
            const aulas = cursoAtual.aulas || [];
            if (aulas.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td style="text-align:center;"><input type="checkbox" class="chk-aula-crono" checked disabled></td><td><strong>Curso Completo (M√≥dulo √önico)</strong></td><td><input type="datetime-local" class="input-date-inline aula-date"></td>`;
                tbody.appendChild(tr);
            } else {
                aulas.sort((a,b) => a.ordem - b.ordem);
                aulas.forEach(a => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="text-align:center;"><input type="checkbox" class="chk-aula-crono" value="${a.id}" onchange="toggleInputDate(this)"></td>
                        <td>${a.ordem}. ${a.titulo} <span style="font-size:0.75rem; color:#64748b; margin-left:10px;">${a.duracao_minutos} min</span></td>
                        <td><input type="datetime-local" class="input-date-inline aula-date" disabled></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            document.getElementById('modal-cronograma').style.display = 'flex';
        };

        window.toggleInputDate = function(checkbox) {
            const row = checkbox.closest('tr');
            const input = row.querySelector('.aula-date');
            input.disabled = !checkbox.checked;
            if(!checkbox.checked) input.value = '';
        };

        window.toggleTodasAulas = function(checked) {
            document.querySelectorAll('.chk-aula-crono').forEach(chk => {
                if(!chk.disabled) { chk.checked = checked; toggleInputDate(chk); }
            });
        };

        window.aplicarDataEmMassa = function() {
            const data = document.getElementById('bulk-date').value;
            if(!data) return alert("Selecione uma data acima primeiro.");
            document.querySelectorAll('.chk-aula-crono:checked').forEach(chk => {
                chk.closest('tr').querySelector('.aula-date').value = data;
            });
        };

        window.salvarAgendamentoFinal = async function() {
            const linhas = document.querySelectorAll('#lista-aulas-cronograma tr');
            const payload = [];
            let erro = false;

            linhas.forEach(tr => {
                const chk = tr.querySelector('.chk-aula-crono');
                if (chk && chk.checked) {
                    const aulaId = chk.value || null;
                    const dataHora = tr.querySelector('.aula-date').value;
                    if (!dataHora) { erro = true; tr.querySelector('.aula-date').style.borderColor = 'red'; }
                    else {
                        alunosSelecionadosIds.forEach(alunoId => {
                            payload.push({ colaborador_id: alunoId, treinamento_id: cursoAtual.id, aula_id: aulaId, data_hora: new Date(dataHora).toISOString(), status: 'AGENDADO' });
                        });
                    }
                }
            });

            if (erro) return alert("Preencha a Data/Hora para todas as aulas marcadas.");
            if (payload.length === 0) return alert("Nenhuma aula selecionada.");

            const btn = document.getElementById('btn-salvar-final');
            btn.innerText = "Salvando..."; btn.disabled = true;

            try {
                await DBHandler.criarAgendamento(payload);
                alert(`‚úÖ ${payload.length} agendamentos criados!`);
                fecharModal('modal-cronograma');
                
                // Reset
                alunosSelecionadosIds.clear(); atualizarBadgeAlunos();
                document.querySelectorAll('.chk-aluno').forEach(c => c.checked = false);
                document.getElementById('sel-treino').value = "";
                resetCronograma();
                
                carregarAgenda();

            } catch (e) { alert("Erro: " + e.message); } 
            finally { btn.innerText = "Confirmar Agendamento"; btn.disabled = false; }
        };

        // Helpers UI
        window.abrirModalAlunos = () => document.getElementById('modal-alunos').style.display = 'flex';
        window.fecharModal = (id) => document.getElementById(id).style.display = 'none';

    </script>
</body>
</html>

