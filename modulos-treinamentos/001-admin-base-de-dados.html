<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração | Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca; --danger: #ef4444; --success: #10b981;
            --bg-gray: #f1f5f9; --text-main: #0f172a; --border-color: #cbd5e1;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { height: 100vh; background-color: var(--bg-gray); font-family: 'Inter', sans-serif; display: flex; flex-direction: column; overflow: hidden; }

        .top-bar { height: 56px; background: #fff; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 24px; }
        .top-bar h1 { font-size: 14px; font-weight: 700; text-transform: uppercase; color: var(--text-main); }

        .main-workspace { flex: 1; padding: 20px; overflow-y: auto; display: flex; justify-content: center; }
        .admin-card { background: #fff; width: 100%; max-width: 1300px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        .tabs-header { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 0 10px; }
        .tab-btn { padding: 15px 20px; border: none; background: none; font-size: 12px; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #eff6ff; }

        .card-body { padding: 20px; display: none; flex: 1; }
        .card-body.active { display: block; }

        /* TABELAS */
        .matrix-container { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        .perm-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .perm-table th { background: #f8fafc; padding: 12px 8px; border-bottom: 2px solid #e2e8f0; color: #475569; }
        .perm-table td { padding: 10px 8px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .perm-table td:first-child { text-align: left; font-weight: 700; color: #1e293b; padding-left: 15px; width: 200px; }

        /* CHECKBOXES */
        .check-ver { accent-color: var(--primary); }
        .check-editar { accent-color: var(--danger); }
        .check-detalhes { accent-color: var(--success); }
        .matrix-cb { width: 16px; height: 16px; cursor: pointer; }
        .highlight-change { background-color: #eef2ff !important; }

        /* BOTÕES */
        .btn-action { background: var(--primary); color: #fff; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; }
        .btn-action:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }
        .btn-cancel { background: #fff; color: #64748b; border: 1px solid #cbd5e1; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; display: none; }

        .filter-bar { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 15px; display: flex; align-items: flex-end; gap: 15px; }
        .log-details-cell { text-align: left !important; font-size: 10px; white-space: pre-line; color: #475569; max-width: 500px; }
    </style>
</head>
<body>

    <header class="top-bar"><h1>Administração de Segurança</h1></header>

    <main class="main-workspace">
        <div class="admin-card">
            <nav class="tabs-header">
                <button class="tab-btn active" data-tab="status">Painel</button>
                <button class="tab-btn" data-tab="permissoes">Matriz de Acesso</button>
                <button class="tab-btn" data-tab="usuarios">Usuários</button>
                <button class="tab-btn" data-tab="logs">Auditoria</button>
            </nav>

            <div id="tab-status" class="card-body active"><div id="metaInfo"></div></div>

            <div id="tab-permissoes" class="card-body">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center;">
                    <p style="font-size: 12px; color: #64748b;">As permissões são aplicadas no próximo login do usuário.</p>
                    <div style="display: flex; gap: 10px;">
                        <button id="btnCancelarMatriz" class="btn-cancel" onclick="window.cancelarAlteracoesMatriz()">Cancelar</button>
                        <button id="btnSalvarPermissoes" class="btn-action" disabled>Gravar Matriz</button>
                    </div>
                </div>
                <div class="matrix-container">
                    <table class="perm-table">
                        <thead><tr id="headerRoles"><th>Módulo</th></tr></thead>
                        <tbody id="permTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-usuarios" class="card-body">
                <div id="gridUsuarios" style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
                    <div id="containerFormNovo" style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                        <h3 style="font-size:13px; margin-bottom:15px;">Novo Acesso</h3>
                        <form id="formNovoUsuario">
                            <input type="text" id="addNome" placeholder="Nome" style="width:100%; padding:8px; margin-bottom:10px;" required>
                            <input type="text" id="addLogin" placeholder="Login" style="width:100%; padding:8px; margin-bottom:10px;" required>
                            <input type="password" id="addSenha" placeholder="Senha" style="width:100%; padding:8px; margin-bottom:10px;" required>
                            <select id="addRole" style="width:100%; padding:8px; margin-bottom:15px;"></select>
                            <button type="submit" class="btn-action" style="width:100%;">Criar</button>
                        </form>
                    </div>
                    <div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <h3 style="font-size:13px;">Usuários do Sistema</h3>
                            <div style="display: flex; gap: 10px;">
                                <button id="btnCancelarUsuarios" class="btn-cancel" onclick="window.carregarUsuarios()">Cancelar</button>
                                <button id="btnSalvarUsuarios" class="btn-action" disabled onclick="window.salvarAlteracoesUsuarios()">Gravar Cargos</button>
                            </div>
                        </div>
                        <div class="matrix-container"><table class="perm-table"><thead><tr><th style="text-align:left; padding-left:15px;">Nome</th><th>Login</th><th>Cargo</th><th>Ação</th></tr></thead><tbody id="listaUsuariosBody"></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="tab-logs" class="card-body">
                <div class="filter-bar">
                    <input type="date" id="logDateInicio" class="filter-input">
                    <input type="date" id="logDateFim" class="filter-input">
                    <select id="logFilterTela" class="filter-input" style="width:200px;"></select>
                    <button class="btn-action" onclick="window.carregarLogs()">Filtrar</button>
                </div>
                <div class="matrix-container"><table class="perm-table"><thead><tr><th style="text-align:left; padding-left:15px;">Data</th><th>Usuário</th><th>Ação</th><th>Detalhes</th><th>Tela</th></tr></thead><tbody id="listaLogsBody"></tbody></table></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { DBHandler, supabaseClient } from '../bd-treinamentos/db-handler.js';

        const ROLES = ['ADMIN', 'TD_COORD', 'RH_OPERACIONAL', 'GESTOR', 'AUDITOR', 'COLABORADOR'];
        let originalMatrixState = [];
        let modulosCache = [];

        document.addEventListener('DOMContentLoaded', () => {
            configurarAbas();
            carregarStatus();
            initMatrix();
            popularRoles();
            popularFiltroTelas();
            verificarModoLeitura();
        });

        function configurarAbas() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn, .card-body').forEach(el => el.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
                    if (btn.dataset.tab === 'usuarios') carregarUsuarios();
                    if (btn.dataset.tab === 'logs') window.carregarLogs();
                };
            });
        }

        async function carregarStatus() {
            const { count: u } = await supabaseClient.from('usuarios_sistema').select('*', { count: 'exact', head: true });
            document.getElementById('metaInfo').innerHTML = `<p style="font-size:12px; color:#64748b;">Sistema conectado. <b>${u}</b> usuários ativos.</p>`;
        }

        function popularRoles() {
            const s = document.getElementById('addRole');
            if(s) s.innerHTML = ROLES.map(r => `<option value="${r}">${r}</option>`).join('');
        }

        // --- MATRIZ ---
        async function initMatrix() {
            const header = document.getElementById('headerRoles');
            const body = document.getElementById('permTableBody');
            header.innerHTML = '<th>Módulo</th>';
            ROLES.forEach(r => header.innerHTML += `<th colspan="3" style="border-left:1px solid #e2e8f0;">${r}<br><small>V | E | D</small></th>`);

            const { data: mods } = await supabaseClient.from('modulos_sistema').select('*').order('ordem');
            const { data: acc } = await supabaseClient.from('acesso_modulos').select('*');
            
            originalMatrixState = acc;
            modulosCache = mods;
            body.innerHTML = '';

            mods.forEach(m => {
                const tr = document.createElement('tr');
                let html = `<td>${m.label}</td>`;
                ROLES.forEach(role => {
                    const a = acc.find(x => x.modulo_id === m.id && x.role === role);
                    html += `
                        <td style="border-left:1px solid #f1f5f9;"><input type="checkbox" class="matrix-cb check-ver" data-mod="${m.id}" data-role="${role}" data-type="Ver" ${a ? 'checked' : ''} onchange="window.verificarMatrix()"></td>
                        <td><input type="checkbox" class="matrix-cb check-editar" data-mod="${m.id}" data-role="${role}" data-type="Editar" ${a?.pode_editar ? 'checked' : ''} onchange="window.verificarMatrix()"></td>
                        <td><input type="checkbox" class="matrix-cb check-detalhes" data-mod="${m.id}" data-role="${role}" data-type="Detalhes" ${a?.ver_detalhes ? 'checked' : ''} onchange="window.verificarMatrix()"></td>
                    `;
                });
                tr.innerHTML = html; body.appendChild(tr);
            });
            window.verificarMatrix();
        }

        window.verificarMatrix = () => {
            const checks = document.querySelectorAll('.matrix-cb');
            let mudou = false;
            checks.forEach(c => {
                const orig = originalMatrixState.find(x => x.modulo_id == c.dataset.mod && x.role == c.dataset.role);
                const type = c.dataset.type;
                let valOrig = false;
                if(type === 'Ver') valOrig = !!orig;
                if(type === 'Editar') valOrig = orig?.pode_editar || false;
                if(type === 'Detalhes') valOrig = orig?.ver_detalhes || false;

                const isDirty = c.checked !== valOrig;
                c.parentElement.classList.toggle('highlight-change', isDirty);
                if(isDirty) mudou = true;
            });
            document.getElementById('btnSalvarPermissoes').disabled = !mudou;
            document.getElementById('btnCancelarMatriz').style.display = mudou ? 'block' : 'none';
        }

        window.cancelarAlteracoesMatriz = () => initMatrix();

        document.getElementById('btnSalvarPermissoes').onclick = async () => {
            const checks = document.querySelectorAll('.matrix-cb');
            const payload = [];
            const logs = [];

            // Detectar mudanças para o log
            checks.forEach(c => {
                const orig = originalMatrixState.find(x => x.modulo_id == c.dataset.mod && x.role == c.dataset.role);
                const type = c.dataset.type;
                let valOrig = false;
                if(type === 'Ver') valOrig = !!orig;
                if(type === 'Editar') valOrig = orig?.pode_editar || false;
                if(type === 'Detalhes') valOrig = orig?.ver_detalhes || false;

                if(c.checked !== valOrig) {
                    const modNome = modulosCache.find(m => m.id == c.dataset.mod)?.label;
                    logs.push(`• [${modNome}] ${c.dataset.role} - ${type}: ${valOrig?'Sim':'Não'} -> ${c.checked?'Sim':'Não'}`);
                }
            });

            // Gerar novo estado para salvar
            ROLES.forEach(r => {
                document.querySelectorAll(`.check-ver[data-role="${r}"]:checked`).forEach(cv => {
                    const mid = cv.dataset.mod;
                    const ce = document.querySelector(`.check-editar[data-mod="${mid}"][data-role="${r}"]`).checked;
                    const cd = document.querySelector(`.check-detalhes[data-mod="${mid}"][data-role="${r}"]`).checked;
                    payload.push({ role: r, modulo_id: parseInt(mid), pode_editar: ce, ver_detalhes: cd });
                });
            });

            if(!confirm("Salvar alterações?\n\n" + logs.join('\n'))) return;

            try {
                const sess = JSON.parse(localStorage.getItem('rh_session'));
                await supabaseClient.from('acesso_modulos').delete().neq('id', 0);
                if(payload.length > 0) await supabaseClient.from('acesso_modulos').insert(payload);
                await DBHandler.registrarLog(sess.user, "ATUALIZAR_MATRIZ", logs.join('\n'), "Administração");
                alert("Salvo!"); initMatrix();
            } catch(e) { alert("Erro ao salvar."); }
        }

        // --- USUÁRIOS ---
        async function carregarUsuarios() {
            const body = document.getElementById('listaUsuariosBody');
            body.innerHTML = '<tr><td colspan="4">...</td></tr>';
            const { data } = await supabaseClient.from('usuarios_sistema').select('*').order('nome');
            body.innerHTML = '';
            data.forEach(u => {
                const opt = ROLES.map(r => `<option value="${r}" ${u.role === r ? 'selected' : ''}>${r}</option>`).join('');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${u.nome}</td><td>${u.username}</td><td><select class="user-sel" data-id="${u.id}" data-orig="${u.role}" data-nome="${u.nome}" onchange="window.verificarUser()">${opt}</select></td><td><button class="btn-danger" onclick="window.excluirUser('${u.id}', '${u.nome}')">Excluir</button></td>`;
                body.appendChild(tr);
            });
            window.verificarUser();
        }

        window.verificarUser = () => {
            const sels = document.querySelectorAll('.user-sel');
            let mudou = false;
            sels.forEach(s => {
                const isDirty = s.value !== s.dataset.orig;
                s.classList.toggle('highlight-change', isDirty);
                if(isDirty) mudou = true;
            });
            document.getElementById('btnSalvarUsuarios').disabled = !mudou;
            document.getElementById('btnCancelarUsuarios').style.display = mudou ? 'block' : 'none';
        }

        window.salvarAlteracoesUsuarios = async () => {
            const dirty = Array.from(document.querySelectorAll('.user-sel')).filter(s => s.value !== s.dataset.orig);
            const sess = JSON.parse(localStorage.getItem('rh_session'));
            const logs = dirty.map(s => `• ${s.dataset.nome}: ${s.dataset.orig} -> ${s.value}`);

            if(!confirm("Salvar cargos?\n\n" + logs.join('\n'))) return;
            for(const s of dirty) {
                await supabaseClient.from('usuarios_sistema').update({ role: s.value }).eq('id', s.dataset.id);
            }
            await DBHandler.registrarLog(sess.user, "ALTERAR_CARGO", logs.join('\n'), "Administração");
            alert("Sucesso!"); carregarUsuarios();
        }

        document.getElementById('formNovoUsuario').onsubmit = async (e) => {
            e.preventDefault();
            const payload = { nome: document.getElementById('addNome').value, username: document.getElementById('addLogin').value, password: document.getElementById('addSenha').value, role: document.getElementById('addRole').value };
            const { error } = await supabaseClient.from('usuarios_sistema').insert([payload]);
            if(!error) { 
                const sess = JSON.parse(localStorage.getItem('rh_session'));
                await DBHandler.registrarLog(sess.user, "CRIAR_USUARIO", `Usuário: ${payload.nome}`, "Administração");
                alert("Criado!"); e.target.reset(); carregarUsuarios(); 
            } else alert(error.message);
        }

        window.excluirUser = async (id, nome) => {
            if(confirm(`Excluir ${nome}?`)) {
                await supabaseClient.from('usuarios_sistema').delete().eq('id', id);
                const sess = JSON.parse(localStorage.getItem('rh_session'));
                await DBHandler.registrarLog(sess.user, "EXCLUIR_USUARIO", nome, "Administração");
                carregarUsuarios();
            }
        }

        // --- LOGS ---
        async function popularFiltroTelas() {
            const { data } = await supabaseClient.from('logs_sistema').select('tela');
            const telas = [...new Set(data.map(l => l.tela).filter(t => t))].sort();
            document.getElementById('logFilterTela').innerHTML = telas.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        window.carregarLogs = async () => {
            const body = document.getElementById('listaLogsBody');
            const d1 = document.getElementById('logDateInicio').value;
            const d2 = document.getElementById('logDateFim').value;
            const tela = document.getElementById('logFilterTela').value;

            body.innerHTML = '<tr><td colspan="5">...</td></tr>';
            let q = supabaseClient.from('logs_sistema').select('*').eq('tela', tela);
            if(d1) q = q.gte('created_at', d1 + 'T00:00:00');
            if(d2) q = q.lte('created_at', d2 + 'T23:59:59');

            const { data } = await q.order('created_at', { ascending: false }).limit(200);
            body.innerHTML = data?.length ? '' : '<tr><td colspan="5">Nenhum registro.</td></tr>';
            data?.forEach(l => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${new Date(l.created_at).toLocaleString()}</td><td>${l.usuario}</td><td><b>${l.acao}</b></td><td class="log-details-cell">${l.detalhes}</td><td>${l.tela}</td>`;
                body.appendChild(tr);
            });
        }

        function verificarModoLeitura() {
            if (new URLSearchParams(window.location.search).get('readonly') === 'true') {
                document.getElementById('btnSalvarPermissoes')?.remove();
                document.getElementById('containerFormNovo')?.remove();
                document.getElementById('areaAcoesUsuarios')?.remove();
                const grid = document.getElementById('gridUsuarios');
                if(grid) { grid.style.gridTemplateColumns = '1fr'; grid.style.gap = '0'; }
                const obs = new MutationObserver(() => {
                    document.querySelectorAll('input, select').forEach(el => el.disabled = true);
                    document.querySelectorAll('.btn-danger').forEach(el => el.remove());
                });
                obs.observe(document.body, { childList: true, subtree: true });
            }
        }
    </script>
</body>
</html>
