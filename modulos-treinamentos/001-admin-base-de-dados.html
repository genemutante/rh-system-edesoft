<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração de Dados | Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Reutilizando sua base de estilos e expandindo */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; display: flex; flex-direction: column; background-color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .top-bar { flex-shrink: 0; height: 56px; background: #ffffff; border-bottom: 1px solid #cbd5e1; display: flex; align-items: center; padding: 0 24px; gap: 16px; z-index: 50; }
        .top-bar h1 { font-size: 16px; font-weight: 700; color: #0f172a; margin: 0; text-transform: uppercase; }
        .main-workspace { flex: 1; display: flex; align-items: flex-start; justify-content: center; padding: 40px 20px; overflow-y: auto; }
        
        .admin-card { background: #ffffff; width: 100%; max-width: 800px; border-radius: 12px; border: 1px solid #cbd5e1; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; }
        .card-header { padding: 15px 24px; border-bottom: 1px solid #f1f5f9; background: #f8fafc; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { margin: 0; font-size: 13px; font-weight: 700; color: #64748b; text-transform: uppercase; }

        /* Sistema de Abas */
        .tabs { display: flex; background: #f1f5f9; padding: 4px; gap: 4px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background: white; color: #3b82f6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .card-body { padding: 24px; display: none; }
        .card-body.active { display: block; }

        /* Tabela de Permissões */
        .perm-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .perm-table th { text-align: left; padding: 12px; background: #f8fafc; color: #475569; border-bottom: 2px solid #e2e8f0; }
        .perm-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .perm-table tr:hover { background: #fcfdfe; }
        
        .role-badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; background: #e2e8f0; color: #475569; }

        .btn-save { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; float: right; margin-top: 20px; }
        .btn-save:hover { background: #2563eb; }

        /* Meta Info Row */
        .meta-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #e2e8f0; font-size: 13px; color: #64748b; }
        .meta-row strong { color: #0f172a; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px; }
        .btn-large { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 16px; border: 1px solid #cbd5e1; border-radius: 6px; background: #fff; cursor: pointer; font-size: 12px; font-weight: 600; color: #475569; }
        .btn-large:hover { border-color: #3b82f6; color: #3b82f6; background: #eff6ff; }
        .btn-large svg { width: 20px; height: 20px; }
    </style>
</head>
<body>

    <header class="top-bar">
        <h1>Painel de Controle do Sistema</h1>
    </header>

    <div class="main-workspace">
        <div class="admin-card">
            
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('status')">Status & Backup</button>
                <button class="tab-btn" onclick="switchTab('permissoes')">Permissões de Acesso</button>
                <button class="tab-btn" onclick="switchTab('usuarios')">Gestão de Usuários</button>
            </div>

            <div id="tab-status" class="card-body active">
                <div id="metaInfo">
                    <div class="meta-row"><span>Status do Banco</span> <strong>Conectado (Supabase)</strong></div>
                </div>
                <div class="action-grid">
                    <div class="btn-large" onclick="DBHandler.exportarArquivo()">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <span>Backup JSON</span>
                    </div>
                    <div class="btn-large" onclick="alert('Funcionalidade em migração para nuvem.')">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                        <span>Otimizar Tabelas</span>
                    </div>
                </div>
            </div>

            <div id="tab-permissoes" class="card-body">
                <p style="font-size: 12px; color: #64748b; margin-bottom: 20px;">Marque os módulos que cada perfil tem permissão para visualizar.</p>
                
                <table class="perm-table">
                    <thead>
                        <tr>
                            <th>Módulo</th>
                            <th>ADMIN</th>
                            <th>VIEWER</th>
                            <th>MATRIZ_ONLY</th>
                        </tr>
                    </thead>
                    <tbody id="permissõesBody">
                        </tbody>
                </table>
                <button class="btn-save" onclick="salvarPermissoes()">Gravar Alterações</button>
            </div>

            <div id="tab-usuarios" class="card-body">
                <div class="empty-state-msg" style="display: block; text-align: center; padding: 40px; color: #94a3b8; border: 1px dashed #cbd5e1; border-radius: 8px;">
                    Ferramenta de Gestão de Usuários em desenvolvimento.
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { DBHandler } from '../bd-treinamentos/db-handler.js';
        window.DBHandler = DBHandler;

        // Lista de perfis do seu sistema
        const ROLES = ['ADMIN', 'VIEWER', 'MATRIZ_ONLY'];

        document.addEventListener('DOMContentLoaded', carregarPermissoes);

        async function carregarPermissoes() {
            try {
                // 1. Busca todos os módulos e todas as permissões atuais
                const { data: modulos } = await DBHandler.supabaseClient.from('modulos_sistema').select('*').order('ordem');
                const { data: acessos } = await DBHandler.supabaseClient.from('acesso_modulos').select('*');

                const tbody = document.getElementById('permissõesBody');
                tbody.innerHTML = '';

                modulos.forEach(mod => {
                    const tr = document.createElement('tr');
                    let html = `<td><strong>${mod.label}</strong></td>`;
                    
                    ROLES.forEach(role => {
                        const temAcesso = acessos.some(a => a.modulo_id === mod.id && a.role === role);
                        html += `
                            <td align="center">
                                <input type="checkbox" class="perm-check" 
                                    data-modulo="${mod.id}" 
                                    data-role="${role}" 
                                    ${temAcesso ? 'checked' : ''}>
                            </td>`;
                    });

                    tr.innerHTML = html;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
            }
        }

        window.salvarPermissoes = async () => {
            if(!confirm("Deseja atualizar as permissões de acesso do sistema?")) return;

            const checks = document.querySelectorAll('.perm-check');
            const novosAcessos = [];

            checks.forEach(c => {
                if(c.checked) {
                    novosAcessos.push({
                        role: c.dataset.role,
                        modulo_id: parseInt(c.dataset.modulo)
                    });
                }
            });

            try {
                // 1. Limpa tudo e reinsere (estratégia simples)
                await DBHandler.supabaseClient.from('acesso_modulos').delete().neq('id', 0);
                await DBHandler.supabaseClient.from('acesso_modulos').insert(novosAcessos);
                
                alert("Permissões atualizadas com sucesso! Os usuários verão as mudanças no próximo carregamento.");
            } catch (err) {
                alert("Erro ao salvar: " + err.message);
            }
        };

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.card-body').forEach(b => b.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');
        };
    </script>
</body>
</html>
