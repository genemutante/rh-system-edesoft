<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administra√ß√£o do Sistema | Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --danger: #ef4444;
            --bg-gray: #f1f5f9;
            --text-main: #0f172a;
            --border-color: #cbd5e1;
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; display: flex; flex-direction: column; background-color: var(--bg-gray); font-family: 'Inter', sans-serif; }

        /* --- HEADER --- */
        .top-bar { flex-shrink: 0; height: 56px; background: #ffffff; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 24px; z-index: 50; }
        .top-bar h1 { font-size: 14px; font-weight: 700; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- LAYOUT --- */
        .main-workspace { flex: 1; display: flex; align-items: flex-start; justify-content: center; padding: 30px 20px; overflow-y: auto; }
        .admin-card { background: #ffffff; width: 100%; max-width: 1100px; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); overflow: hidden; }
        
        /* --- ABAS --- */
        .tabs-header { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; padding: 0 12px; }
        .tab-btn { padding: 14px 20px; border: none; background: none; font-size: 12px; font-weight: 600; color: #64748b; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #eff6ff; }

        .card-body { padding: 24px; display: none; }
        .card-body.active { display: block; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TABELAS --- */
        .matrix-container { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        .perm-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .perm-table th { background: #f8fafc; padding: 10px; text-align: center; color: #475569; border-bottom: 2px solid #e2e8f0; }
        .perm-table th:first-child { text-align: left; font-size: 12px; }
        .perm-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .perm-table td:first-child { text-align: left; font-weight: 600; color: #1e293b; font-size: 12px; }
        
        .check-ver { accent-color: var(--primary); cursor: pointer; }
        .check-editar { accent-color: var(--danger); cursor: pointer; }
        
        .role-badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; background: #e0e7ff; color: #4338ca; text-transform: uppercase; }

        /* --- FORMUL√ÅRIOS --- */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; outline: none; }
        .input-group input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* --- BOT√ïES --- */
        .btn-action { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; transition: background 0.2s; }
        .btn-action:hover { background: var(--primary-hover); }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-danger { background: none; border: none; color: var(--danger); font-size: 11px; font-weight: 700; cursor: pointer; }
        .btn-danger:hover { text-decoration: underline; }

        .info-box { background: #fff7ed; border: 1px solid #ffedd5; color: #9a3412; padding: 12px; border-radius: 8px; font-size: 12px; margin-bottom: 20px; line-height: 1.5; }
    </style>
</head>
<body>

    <header class="top-bar">
        <h1>Centro de Administra√ß√£o do Sistema</h1>
    </header>

    <div class="main-workspace">
        <div class="admin-card">
            
            <nav class="tabs-header">
                <button class="tab-btn active" data-tab="status">Status & Backup</button>
                <button class="tab-btn" data-tab="permissoes">Matriz de Permiss√µes</button>
                <button class="tab-btn" data-tab="usuarios">Gest√£o de Usu√°rios</button>
            </nav>

            <div id="tab-status" class="card-body active">
                <div class="info-box">Monitoramento em tempo real da base de dados Academy integrada ao Supabase Cloud.</div>
                <div id="metaInfo">
                    </div>
            </div>

            <div id="tab-permissoes" class="card-body">
                <div class="info-box">
                    <strong>Configura√ß√£o de Acesso:</strong> Marque <b>VER</b> para permitir acesso ao m√≥dulo e <b>EDITAR</b> para liberar fun√ß√µes de grava√ß√£o/exclus√£o. Usu√°rios sem a marca√ß√£o "Editar" abrir√£o os m√≥dulos em modo de leitura autom√°tica.
                </div>
                
                <div class="matrix-container">
                    <table class="perm-table">
                        <thead>
                            <tr id="headerRoles">
                                <th>M√≥dulo</th>
                                </tr>
                        </thead>
                        <tbody id="permTableBody">
                            <tr><td colspan="13" align="center">Carregando matriz de permiss√µes...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn-action" id="btnSalvarPermissoes">Gravar Matriz de Acesso</button>
                </div>
            </div>

            <div id="tab-usuarios" class="card-body">
                <div style="display: grid; grid-template-columns: 320px 1fr; gap: 30px;">
                    
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h3 style="font-size: 14px; margin-bottom: 15px;">Novo Acesso</h3>
                        <form id="formNovoUsuario">
                            <div class="input-group">
                                <label>Nome Completo</label>
                                <input type="text" id="addNome" placeholder="Ex: Jos√© Silva" required>
                            </div>
                            <div class="input-group">
                                <label>Login (Username)</label>
                                <input type="text" id="addLogin" placeholder="Ex: jose.silva" required>
                            </div>
                            <div class="input-group">
                                <label>Senha Inicial</label>
                                <input type="password" id="addSenha" placeholder="M√≠nimo 6 d√≠gitos" required>
                            </div>
                            <div class="input-group">
                                <label>Cargo (Role)</label>
                                <select id="addRole">
                                    <option value="COLABORADOR">COLABORADOR</option>
                                    <option value="GESTOR">GESTOR</option>
                                    <option value="RH_OPERACIONAL">RH OPERACIONAL</option>
                                    <option value="TD_COORD">COORDENADOR T&D</option>
                                    <option value="AUDITOR">AUDITOR</option>
                                    <option value="ADMIN">ADMINISTRADOR</option>
                                </select>
                            </div>
                            <button type="submit" class="btn-action" style="width: 100%;">Criar Usu√°rio</button>
                        </form>
                    </div>

                    <div>
                        <h3 style="font-size: 14px; margin-bottom: 15px;">Usu√°rios Registrados</h3>
                        <div class="matrix-container">
                            <table class="perm-table">
                                <thead>
                                    <tr>
                                        <th style="text-align: left; padding-left: 15px;">Nome</th>
                                        <th>Login</th>
                                        <th>Cargo</th>
                                        <th>A√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody id="listaUsuariosBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { DBHandler, supabaseClient } from '../bd-treinamentos/db-handler.js';

        const ROLES = ['ADMIN', 'TD_COORD', 'RH_OPERACIONAL', 'GESTOR', 'AUDITOR', 'COLABORADOR'];

        document.addEventListener('DOMContentLoaded', () => {
            configurarAbas();
            carregarStatus();
            initMatrix();
        });

        // 1. GEST√ÉO DE ABAS
        function configurarAbas() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.tab-btn, .card-body').forEach(el => el.classList.remove('active'));
                    btn.classList.add('active');
                    const tabId = 'tab-' + btn.dataset.tab;
                    document.getElementById(tabId).classList.add('active');

                    if (btn.dataset.tab === 'usuarios') carregarUsuarios();
                    if (btn.dataset.tab === 'permissoes') initMatrix();
                };
            });
        }

        // 2. STATUS DO SISTEMA
        async function carregarStatus() {
            try {
                const { count: users } = await supabaseClient.from('usuarios_sistema').select('*', { count: 'exact', head: true });
                const { count: mods } = await supabaseClient.from('modulos_sistema').select('*', { count: 'exact', head: true });
                
                document.getElementById('metaInfo').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="padding: 15px; background: #eff6ff; border-radius: 8px; border: 1px solid #dbeafe;">
                            <span style="display:block; font-size:11px; color:#1d4ed8; font-weight:700;">USU√ÅRIOS ATIVOS</span>
                            <strong style="font-size:24px;">${users || 0}</strong>
                        </div>
                        <div style="padding: 15px; background: #f0fdf4; border-radius: 8px; border: 1px solid #dcfce7;">
                            <span style="display:block; font-size:11px; color:#15803d; font-weight:700;">M√ìDULOS NO SISTEMA</span>
                            <strong style="font-size:24px;">${mods || 0}</strong>
                        </div>
                    </div>
                `;
            } catch (e) { console.error(e); }
        }

   // 3. MATRIZ DE PERMISS√ïES DIN√ÇMICA (VER | EDITAR | DETALHES)
async function initMatrix() {
    const header = document.getElementById('headerRoles');
    const body = document.getElementById('permTableBody');
    
    // Cabe√ßalho com Tr√™s Colunas por Role (V | E | D)
    header.innerHTML = '<th>M√≥dulo do Sistema</th>';
    ROLES.forEach(r => {
        header.innerHTML += `
            <th colspan="3" style="border-left: 1px solid #e2e8f0; width: 180px;">
                ${r}<br>
                <span style="font-size:8px; color:#94a3b8">VER | EDITAR | DETALHES</span>
            </th>`;
    });

    try {
        const { data: modulos } = await supabaseClient.from('modulos_sistema').select('*').order('ordem');
        const { data: acessos } = await supabaseClient.from('acesso_modulos').select('*');

        body.innerHTML = '';
        modulos.forEach(mod => {
            const tr = document.createElement('tr');
            let html = `<td style="text-align:left"><strong>${mod.label}</strong></td>`;
            
            ROLES.forEach(role => {
                const acesso = acessos.find(a => a.modulo_id === mod.id && a.role === role);
                const podeVer = !!acesso;
                const podeEditar = acesso ? acesso.pode_editar : false;
                const podeDetalhar = acesso ? acesso.ver_detalhes : false;

                html += `
                    <td style="border-left: 1px solid #f1f5f9; width: 60px;">
                        <input type="checkbox" class="check-ver" data-modulo="${mod.id}" data-role="${role}" ${podeVer ? 'checked' : ''}>
                    </td>
                    <td style="width: 60px;">
                        <input type="checkbox" class="check-editar" data-modulo="${mod.id}" data-role="${role}" ${podeEditar ? 'checked' : ''}>
                    </td>
                    <td style="width: 60px;">
                        <input type="checkbox" class="check-detalhes" data-modulo="${mod.id}" data-role="${role}" ${podeDetalhar ? 'checked' : ''}>
                    </td>`;
            });
            tr.innerHTML = html;
            body.appendChild(tr);
        });
    } catch (err) {
        body.innerHTML = `<tr><td colspan="${(ROLES.length * 3) + 1}">Erro ao carregar matriz: ${err.message}</td></tr>`;
    }
}

document.getElementById('btnSalvarPermissoes').onclick = async () => {
    if (!confirm("Confirmar a atualiza√ß√£o das permiss√µes granulares?")) return;
    
    const btn = document.getElementById('btnSalvarPermissoes');
    const payload = [];

    // Captura l√≥gica para os tr√™s estados
    ROLES.forEach(role => {
        // Apenas processamos m√≥dulos onde o "VER" est√° marcado
        const checksVer = document.querySelectorAll(`.check-ver[data-role="${role}"]:checked`);
        
        checksVer.forEach(cbVer => {
            const moduloId = cbVer.dataset.modulo;
            
            // Localiza os checkboxes irm√£os (Editar e Detalhes) para este m√≥dulo/role
            const cbEditar = document.querySelector(`.check-editar[data-modulo="${moduloId}"][data-role="${role}"]`);
            const cbDetalhes = document.querySelector(`.check-detalhes[data-modulo="${moduloId}"][data-role="${role}"]`);
            
            payload.push({
                role: role,
                modulo_id: parseInt(moduloId),
                pode_editar: cbEditar ? cbEditar.checked : false,
                ver_detalhes: cbDetalhes ? cbDetalhes.checked : false
            });
        });
    });

    try {
        btn.disabled = true;
        btn.textContent = "Gravando Altera√ß√µes...";

        // 1. Limpa as permiss√µes atuais
        const { error: delError } = await supabaseClient.from('acesso_modulos').delete().neq('id', 0);
        if (delError) throw delError;

        // 2. Insere a nova matriz configurada
        if (payload.length > 0) {
            const { error: insError } = await supabaseClient.from('acesso_modulos').insert(payload);
            if (insError) throw insError;
        }
        
        alert("Matriz de permiss√µes salva com sucesso! O sistema aplicar√° as regras no pr√≥ximo acesso de cada usu√°rio.");
    } catch (e) {
        alert("Erro ao salvar matriz no banco: " + e.message);
    } finally {
        btn.disabled = false;
        btn.textContent = "Gravar Matriz de Acesso";
        initMatrix(); // Recarrega para garantir sincronia visual
    }
};
        // 4. GEST√ÉO DE USU√ÅRIOS
// --- GEST√ÉO DE USU√ÅRIOS: CARREGAMENTO COM EDI√á√ÉO ---
async function carregarUsuarios() {
    const tbody = document.getElementById('listaUsuariosBody');
    tbody.innerHTML = '<tr><td colspan="4" align="center">Buscando usu√°rios...</td></tr>';

    try {
        const { data: usuarios, error } = await supabaseClient
            .from('usuarios_sistema')
            .select('*')
            .order('nome');

        if (error) throw error;

        tbody.innerHTML = '';
        usuarios.forEach(u => {
            const tr = document.createElement('tr');
            
            const optionsHtml = ROLES.map(role => 
                `<option value="${role}" ${u.role === role ? 'selected' : ''}>${role}</option>`
            ).join('');

            tr.innerHTML = `
                <td style="text-align:left; padding-left: 15px;"><strong>${u.nome}</strong></td>
                <td><code>${u.username}</code></td>
                <td>
                    <select id="select-role-${u.id}" 
                            style="font-size: 11px; padding: 4px; border-radius: 4px; border: 1px solid #cbd5e1; background: #fff;">
                        ${optionsHtml}
                    </select>
                </td>
                <td style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn-save-row" onclick="window.salvarAlteracaoCargo('${u.id}', '${u.nome}')" 
                            style="background: #10b981; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; cursor: pointer;">
                        Salvar
                    </button>
                    <button class="btn-danger" onclick="window.removerUser('${u.id}', '${u.nome}')">Excluir</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (err) {
        console.error("Erro ao listar usu√°rios:", err);
    }
}

// Fun√ß√£o para gravar a altera√ß√£o de cargo no banco
window.atualizarRoleUsuario = async (userId, novaRole) => {
    const session = JSON.parse(localStorage.getItem('rh_session'));

    // Seguran√ßa: Aviso caso o admin esteja alterando a pr√≥pria role
    if (userId === session.userId && novaRole !== 'ADMIN') {
        if (!confirm("Aten√ß√£o: Voc√™ est√° alterando seu pr√≥prio cargo. Se confirmar, poder√° perder acesso a esta tela. Deseja continuar?")) {
            carregarUsuarios(); // Recarrega para voltar o valor original
            return;
        }
    }

    try {
        const { error } = await supabaseClient
            .from('usuarios_sistema')
            .update({ role: novaRole })
            .eq('id', userId);

        if (error) throw error;

        // Feedback visual r√°pido
        console.log(`Cargo de ${userId} atualizado para ${novaRole}`);
        alert("Cargo atualizado com sucesso!");
        
        // Se o usu√°rio alterou a pr√≥pria role, precisamos atualizar a sess√£o
        if (userId === session.userId) {
            session.role = novaRole;
            localStorage.setItem('rh_session', JSON.stringify(session));
            alert("Suas permiss√µes mudaram. A p√°gina ser√° recarregada.");
            window.parent.location.reload(); // Recarrega o app-view completo
        }

    } catch (err) {
        alert("Erro ao atualizar cargo: " + err.message);
        carregarUsuarios(); // Reverte a altera√ß√£o visual em caso de erro
    }
};

        document.getElementById('formNovoUsuario').onsubmit = async (e) => {
            e.preventDefault();
            const user = {
                nome: document.getElementById('addNome').value.trim(),
                username: document.getElementById('addLogin').value.trim(),
                password: document.getElementById('addSenha').value.trim(),
                role: document.getElementById('addRole').value
            };

            if (user.password.length < 6) {
                alert("A senha deve ter no m√≠nimo 6 d√≠gitos.");
                return;
            }

            const { error } = await supabaseClient.from('usuarios_sistema').insert([user]);
            if (!error) { 
                alert("Usu√°rio criado com sucesso!"); 
                e.target.reset(); 
                carregarUsuarios(); 
            } else { 
                alert("Erro: " + error.message); 
            }
        };

        window.removerUser = async (id, nome) => {
            if (confirm(`Remover permanentemente o acesso de ${nome}?`)) {
                const { error } = await supabaseClient.from('usuarios_sistema').delete().eq('id', id);
                if (!error) carregarUsuarios();
                else alert("Erro ao excluir: " + error.message);
            }
        };



        // Fun√ß√£o para bloquear a tela caso o usu√°rio seja apenas leitor
function verificarModoLeitura() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('readonly') === 'true') {
        console.log("üõ°Ô∏è Ajustando layout para modo leitura.");
        
        // 1. Esconde o bot√£o de salvar matriz
        const btnSalvar = document.getElementById('btnSalvarPermissoes');
        if (btnSalvar) btnSalvar.remove();

        // 2. Ajusta a aba de Gest√£o de Usu√°rios
        const formNovo = document.getElementById('formNovoUsuario');
        if (formNovo) {
            const formContainer = formNovo.closest('div');
            const gridContainer = formContainer.parentElement; // O container que tem o display: grid

            // Esconde o container do formul√°rio
            formContainer.style.display = 'none'; 

            // ESSA √â A CHAVE: Muda o grid de "320px 1fr" para "1fr" (largura total)
            gridContainer.style.gridTemplateColumns = '1fr';
            gridContainer.style.gap = '0'; 
        }

        // 3. Bloqueio de intera√ß√£o (MutationObserver)
        const observer = new MutationObserver(() => {
            document.querySelectorAll('input[type="checkbox"], select').forEach(el => {
                // No caso do Auditor, deixamos o select de cargo vis√≠vel mas desativado
                el.disabled = true;
                el.style.cursor = 'not-allowed';
            });
            document.querySelectorAll('.btn-danger').forEach(el => el.remove());
        });

        observer.observe(document.body, { childList: true, subtree: true });
    }
}

// Chame esta fun√ß√£o no final do seu DOMContentLoaded
document.addEventListener('DOMContentLoaded', () => {
    configurarAbas();
    carregarStatus();
    initMatrix();
    verificarModoLeitura(); // <-- Nova trava aqui
});
    </script>
</body>
</html>






